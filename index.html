<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Outfit:wght@100;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <title>Prism OS</title>
    <style>
        :root {
            --accent: #007AFF;
            --accent-fg: #fff;       /* text ON top of accent-colored elements */
            --smooth-ease: cubic-bezier(0.4, 0, 0.2, 1);
            --slow-ease: cubic-bezier(0.65, 0, 0.35, 1);
            --widget-shadow: drop-shadow(0px 0px 12px rgba(0,0,0,0.9));
        }

        /* ‚îÄ‚îÄ WIDGET PILL ‚îÄ‚îÄ */
        .widget-pill {
            background: rgba(0,0,0,0); border-radius: 20px;
            padding: 0; transition: background 0.4s ease, padding 0.4s ease, backdrop-filter 0.4s ease;
        }
        body.show-pills .widget-pill {
            background: rgba(0,0,0,0.35);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            padding: 10px 20px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        /* ‚îÄ‚îÄ WHITE ACCENT FIXES ‚îÄ‚îÄ */
        /* switches: when active & accent is white, use a dark thumb so it's visible */
        .ios-switch.active { background: var(--accent); }
        .ios-switch.active::after { background: var(--accent-fg); }
        /* update/save buttons use accent-fg for text */
        .update-btn { background: var(--accent); color: var(--accent-fg); }
        /* reset-link hover uses accent-fg for text */
        .reset-link:hover { background: var(--accent); color: var(--accent-fg); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            background-color: #000; color: #fff; margin: 0; padding: 0;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            font-family: -apple-system, system-ui, sans-serif;
            overflow: hidden;
            position: fixed; /* locks iOS rubber-band scroll */
        }

        body { animation: pageEntrance 1.5s var(--slow-ease) forwards; opacity: 0; }

        @keyframes pageEntrance {
            from { opacity: 0; transform: scale(1.03); filter: blur(5px); }
            to   { opacity: 1; transform: scale(1);    filter: blur(0px); }
        }

        #bg-layer {
            position: fixed; inset: -50px; z-index: -1;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            transition: opacity 0.3s, filter 0.3s; pointer-events: none;
        }

        /* #hud-master is now a transparent passthrough ‚Äî widgets position themselves */
        #hud-master { position: fixed; inset: 0; pointer-events: none; z-index: 10; }

        .widget {
            position: fixed;
            display: flex; justify-content: center; align-items: center;
            color: var(--accent); filter: var(--widget-shadow);
            pointer-events: all;
            cursor: grab;
            user-select: none; -webkit-user-select: none;
            /* spring snap animation */
            transition: left 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
                        top  0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
                        opacity 0.4s ease, transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .widget:hover { filter: var(--widget-shadow) brightness(1.08); }
        .widget.dragging {
            transition: opacity 0.15s ease;
            cursor: grabbing; z-index: 500;
            opacity: 0.8;
        }
        @keyframes wiggle {
            0%,100% { transform: translate(-50%,-50%) rotate(0deg) scale(var(--ws,1)); }
            25%  { transform: translate(-50%,-50%) rotate(-1.5deg) scale(var(--ws,1)); }
            75%  { transform: translate(-50%,-50%) rotate(1.5deg)  scale(var(--ws,1)); }
        }
        .widget.long-press-ready { animation: wiggle 0.35s ease; }

        /* snap ghosts removed ‚Äî grid is invisible, snapping still works */

        /* ‚îÄ‚îÄ CLOCK STYLES ‚îÄ‚îÄ */
        #clock { line-height: 1; transition: all 0.4s ease; text-shadow: 0px 0px 20px rgba(0,0,0,0.5); }
        #clock.style-bold {
            font-size: clamp(5rem, 25vw, 12rem); font-weight: 900; font-style: italic;
            letter-spacing: -4px; font-family: -apple-system, system-ui, sans-serif;
        }
        #clock.style-thin {
            font-size: clamp(4rem, 22vw, 11rem); font-weight: 100; font-style: normal;
            font-family: 'Outfit', sans-serif; letter-spacing: 20px;
        }
        #clock.style-retro {
            font-size: clamp(3.5rem, 18vw, 9rem); font-family: 'Share Tech Mono', monospace;
            font-weight: normal; font-style: normal; letter-spacing: 10px;
            text-shadow: 0 0 8px currentColor, 0 0 25px currentColor, 0 0 60px currentColor;
        }

        /* Analog clock */
        #analog-clock {
            display: none; width: clamp(180px, 40vw, 320px); height: clamp(180px, 40vw, 320px);
        }
        .a-face { fill: none; stroke: var(--accent); stroke-width: 1.5; opacity: 0.2; }
        .a-tick { stroke: var(--accent); stroke-width: 1.5; opacity: 0.4; }
        .a-tick-major { stroke: var(--accent); stroke-width: 3; opacity: 0.7; }
        .a-hour { stroke: var(--accent); stroke-width: 5; stroke-linecap: round; filter: drop-shadow(0 0 6px var(--accent)); }
        .a-min  { stroke: var(--accent); stroke-width: 3; stroke-linecap: round; filter: drop-shadow(0 0 4px var(--accent)); }
        .a-sec  { stroke: #fff; stroke-width: 1.5; stroke-linecap: round; }
        .a-center { fill: var(--accent); }

        #date { font-size: 1.4rem; text-transform: uppercase; letter-spacing: 8px; opacity: 0.8; font-weight: 300; text-shadow: 0px 0px 20px rgba(0,0,0,0.7); }
        #weather-widget { gap: 20px; opacity: 0.8; font-size: 2.4rem; font-weight: 200; text-shadow: 0px 0px 20px rgba(0,0,0,0.7); }
        #battery-widget { font-size: 1.2rem; font-weight: 600; opacity: 0.8; letter-spacing: 4px; display: flex; align-items: center; gap: 12px; text-shadow: 0px 0px 20px rgba(0,0,0,0.7); }
        .charging-pulse { animation: batteryPulse 2s infinite ease-in-out; }
        @keyframes batteryPulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        /* ‚îÄ‚îÄ NOW PLAYING WIDGET ‚îÄ‚îÄ */
        #nowplaying-widget {
            flex-direction: row !important; gap: 14px;
            max-width: 380px; width: 90%; opacity: 0.9; align-items: center;
            filter: var(--widget-shadow) drop-shadow(0px 0px 20px rgba(0,0,0,0.7));
        }
        #np-art {
            width: 56px; height: 56px; border-radius: 10px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden; flex-shrink: 0; transition: border-color 0.3s;
            display: flex; align-items: center; justify-content: center; font-size: 1.6rem; opacity: 0.3;
        }
        #np-art.has-art { border-color: var(--accent); box-shadow: 0 0 20px rgba(0,0,0,0.6); opacity: 1; }
        #np-art img { width: 100%; height: 100%; object-fit: cover; }
        #np-info { text-align: left; overflow: hidden; flex: 1; min-width: 0; }
        #np-track { font-size: 0.9rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; }
        #np-artist { font-size: 0.72rem; opacity: 0.55; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 400; }
        #np-bar { width: 100%; height: 2px; background: rgba(255,255,255,0.1); border-radius: 1px; margin-top: 8px; overflow: hidden; }
        #np-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: width 1s linear; }
        #np-label { font-size: 0.5rem; text-transform: uppercase; letter-spacing: 3px; opacity: 0.3; margin-top: 5px; font-weight: 600; }

        /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
        #nav-trigger {
            position: absolute; bottom: 40px; right: 40px; width: 65px; height: 65px;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; cursor: pointer;
            transition: opacity 0.8s var(--smooth-ease), transform 0.3s var(--smooth-ease), background 0.3s, border-color 0.3s;
            opacity: 0.6; color: #fff;
        }
        #nav-ghost-zone { position: absolute; bottom: 0; right: 0; width: 150px; height: 150px; z-index: 999; }
        #nav-trigger:hover, #nav-trigger.active-ui { opacity: 1 !important; transform: scale(1.1) rotate(15deg); background: rgba(255,255,255,0.2); border-color: var(--accent); box-shadow: 0 0 20px rgba(255,255,255,0.1); }

        /* ‚îÄ‚îÄ FULLSCREEN BUTTON ‚îÄ‚îÄ */
        #fullscreen-btn {
            position: absolute; bottom: 40px; left: 40px;
            width: 44px; height: 44px;
            background: rgba(255,255,255,0.07); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; cursor: pointer; color: #fff;
            transition: opacity 0.8s var(--smooth-ease), transform 0.3s var(--smooth-ease), background 0.3s, border-color 0.3s;
            opacity: 0;
        }
        #fullscreen-btn:hover { opacity: 1 !important; background: rgba(255,255,255,0.15); border-color: var(--accent); transform: scale(1.1); }

        /* ‚îÄ‚îÄ KEYBOARD SHORTCUT TOAST ‚îÄ‚îÄ */
        #kb-toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: rgba(20,20,20,0.92); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 14px;
            padding: 10px 18px; font-size: 0.7rem; letter-spacing: 1px;
            color: rgba(255,255,255,0.6); z-index: 4000; pointer-events: none;
            opacity: 0; transition: opacity 0.3s, transform 0.3s;
            white-space: nowrap;
        }
        #kb-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ‚îÄ‚îÄ AUTO-DIM ‚îÄ‚îÄ */
        #dim-overlay {
            position: fixed; inset: 0; background: #000;
            opacity: 0; pointer-events: none;
            transition: opacity 2s ease; z-index: 900;
        }
        #dim-overlay.dimmed { opacity: 0.82; pointer-events: none; }

        /* ‚îÄ‚îÄ SIDE PANEL ‚îÄ‚îÄ */
        #side-panel {
            position: fixed; right: -380px; top: 0; bottom: 0; width: 360px;
            background: rgba(10,10,10,0.98); backdrop-filter: blur(60px);
            padding: 40px 25px;
            transition: right 0.4s var(--smooth-ease);
            z-index: 2000; overflow-y: auto;
            touch-action: pan-y; /* re-enable vertical scroll inside panel */
            border-left: 1px solid rgba(255,255,255,0.1); color: #fff; scrollbar-width: none;
        }
        #side-panel.open { right: 0 !important; }
        #side-panel::-webkit-scrollbar { display: none; }

        .panel-content { display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }

        .control-group { padding: 18px; background: rgba(255,255,255,0.05); border-radius: 20px; border: 1px solid transparent; transition: 0.2s; position: relative; }
        .control-group:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); }

        #weather-results {
            position: absolute; top: 95%; left: 18px; right: 18px;
            background: rgba(20,20,20,0.95); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 15px;
            z-index: 3000; max-height: 200px; overflow-y: auto; display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .city-item { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-size: 0.8rem; transition: 0.2s; text-align: left; }
        .city-item:hover { background: var(--accent); color: white; }
        .city-item span { opacity: 0.6; font-size: 0.7rem; display: block; }

        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.5; font-weight: 800; }

        .status-tag { font-size: 0.55rem; font-weight: 900; letter-spacing: 1px; margin-right: 10px; transition: 0.3s; }
        .status-tag.off { opacity: 0.3; color: #fff; }
        .status-tag.on  { opacity: 1; color: var(--accent); }

        .update-btn { border: none; width: 100%; padding: 12px; border-radius: 12px; margin-top: 10px; font-weight: bold; cursor: pointer; transition: all 0.3s var(--smooth-ease); }

        .ios-switch { position: relative; width: 50px; height: 28px; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer; transition: all 0.3s ease; }
        .ios-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 24px; height: 24px; border-radius: 50%; transition: 0.3s; background: #fff; }
        .ios-switch.active::after { transform: translateX(22px); }
        .ios-switch:hover { filter: brightness(1.3); box-shadow: 0 0 12px rgba(255,255,255,0.1); }
        .ios-switch.active:hover { box-shadow: 0 0 15px var(--accent); }

        .file-upload-btn { display: block; width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.3); border-radius: 12px; color: #fff; text-align: center; font-size: 0.75rem; font-weight: 600; cursor: pointer; margin-bottom: 15px; transition: all 0.3s var(--smooth-ease); }
        .file-upload-btn:hover { background: rgba(255,255,255,0.15); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); transform: translateY(-1px); }

        .wallpaper-grid { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 5px; }
        #static-bg-preview { width: 70px; height: 70px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; position: relative; overflow: hidden; transition: 0.3s; }
        #static-bg-preview.active { border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }
        #static-bg-preview input { position: absolute; opacity: 0; inset: 0; cursor: pointer; width: 100%; height: 100%; }
        .bg-thumb { width: 70px; height: 70px; border-radius: 12px; background-size: cover; background-position: center; border: 2px solid transparent; cursor: pointer; transition: 0.3s; opacity: 0.5; }
        .bg-thumb.active { border-color: var(--accent); opacity: 1; transform: scale(1.05); }

        .theme-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.4); padding: 10px 12px; border-radius: 10px; margin-top: 8px; }
        .theme-actions button { background: none; border: none; color: #fff; font-size: 0.7rem; font-weight: bold; cursor: pointer; opacity: 0.7; margin-left: 10px; }

        input[type="text"] { width: 100%; background: #000; border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 12px; margin-top: 10px; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(0,122,255,0.2); }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.1); margin-top: 10px; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; background: #fff; border-radius: 50%; cursor: pointer; }

        .update-btn:hover { filter: brightness(1.2); box-shadow: 0 0 15px var(--accent); transform: translateY(-1px); }
        .reset-link { font-size: 0.65rem; color: var(--accent); cursor: pointer; text-transform: uppercase; font-weight: 900; padding: 4px 8px; background: rgba(0,0,0,0.3); border-radius: 6px; transition: all 0.2s ease; }
        .reset-link:hover { box-shadow: 0 0 10px var(--accent); transform: scale(1.05); }

        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1500; }
        #confirm-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(10px); }
        .modal-box { background: #111; border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 25px; text-align: center; max-width: 300px; }
        .modal-box h3 { margin-top: 0; color: #ff4444; }
        .modal-box p { font-size: 0.85rem; opacity: 0.7; margin-bottom: 25px; }
        .modal-btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .factory-reset-btn { color: #ff4444; background: none; border: 1px solid rgba(255,68,68,0.2); font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; padding: 10px; border-radius: 10px; transition: all 0.3s ease; }
        .factory-reset-btn:hover { color: #fff; background: #ff4444; border-color: #ff4444; box-shadow: 0 0 20px rgba(255,68,68,0.6); transform: scale(0.98); }

        /* ‚îÄ‚îÄ CLOCK STYLE PICKER ‚îÄ‚îÄ */
        .style-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 12px; }
        .style-btn { padding: 12px 4px; background: rgba(255,255,255,0.05); border: 1px solid transparent; border-radius: 12px; color: #fff; font-size: 0.52rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; text-align: center; transition: 0.2s; }
        .style-btn:hover { background: rgba(255,255,255,0.1); }
        .style-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,122,255,0.1); }
        .style-btn .s-icon { font-size: 1.3rem; display: block; margin-bottom: 5px; }

        /* ‚îÄ‚îÄ AMBIENT SOUND ‚îÄ‚îÄ */
        .ambient-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 12px; }
        .ambient-btn { padding: 14px 8px; background: rgba(255,255,255,0.05); border: 1px solid transparent; border-radius: 12px; color: #fff; font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; text-align: center; transition: 0.2s; }
        .ambient-btn:hover { background: rgba(255,255,255,0.1); }
        .ambient-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,122,255,0.1); box-shadow: 0 0 14px rgba(0,122,255,0.15); }
        .ambient-btn .a-icon { font-size: 1.6rem; display: block; margin-bottom: 5px; }

        .vol-row { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
        .vol-row label { white-space: nowrap; opacity: 0.4; font-size: 0.55rem; }
        .vol-row input { flex: 1; margin-top: 0; }

        /* ‚îÄ‚îÄ SPOTIFY ‚îÄ‚îÄ */
        .spotify-connected { display: flex; align-items: center; gap: 8px; font-size: 0.72rem; color: #1DB954; font-weight: 700; margin-bottom: 10px; }
        .spotify-connected .dot { width: 7px; height: 7px; background: #1DB954; border-radius: 50%; animation: sdot 2s infinite ease-in-out; }
        @keyframes sdot { 0%,100%{opacity:1} 50%{opacity:0.3} }
        .spotify-note { font-size: 0.68rem; opacity: 0.45; line-height: 1.6; margin-top: 10px; }
        .spotify-note a { color: var(--accent); }

        /* ‚îÄ‚îÄ PLAYBACK CONTROLS ‚îÄ‚îÄ */
        #np-controls { display: flex; align-items: center; gap: 14px; margin-top: 8px; }
        #np-controls > div { flex: 1; min-width: 0; }
        .np-btn {
            background: none; border: none; color: var(--accent);
            cursor: pointer; padding: 0; opacity: 0.65; line-height: 1;
            transition: opacity 0.2s, transform 0.15s;
            filter: var(--widget-shadow);
            flex-shrink: 0;
        }
        .np-btn:hover  { opacity: 1; transform: scale(1.2); }
        .np-btn:active { transform: scale(0.88); }
        #np-playpause  { opacity: 1; }
        .np-premium-note { font-size: 0.46rem; opacity: 0.28; letter-spacing: 1.5px; text-transform: uppercase; margin-top: 3px; color: #fff; }

        /* ‚îÄ‚îÄ STOCKS WIDGET ‚îÄ‚îÄ */
        #stocks-widget { flex-direction: column !important; gap: 6px; align-items: stretch; }
        #stocks-widget .widget-pill { flex-direction: column; gap: 5px; min-width: 180px; }
        .stock-row {
            display: flex; align-items: center; justify-content: space-between;
            gap: 14px; padding: 2px 0;
        }
        .stock-ticker {
            font-size: 0.78rem; font-weight: 800; letter-spacing: 1.5px;
            color: var(--accent); min-width: 44px;
        }
        .stock-price {
            font-size: 0.95rem; font-weight: 600; color: #fff;
            text-shadow: 0 0 18px rgba(0,0,0,0.8);
        }
        .stock-change {
            font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px;
            min-width: 58px; text-align: right;
        }
        .stock-change.up   { color: #34C759; }
        .stock-change.down { color: #ff4444; }
        .stock-divider {
            height: 1px; background: rgba(255,255,255,0.07); margin: 1px 0;
        }
        .stock-label {
            font-size: 0.42rem; letter-spacing: 3px; opacity: 0.25;
            text-transform: uppercase; text-align: right; margin-top: 2px;
        }
        /* settings ticker tags */
        .ticker-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .ticker-tag {
            display: flex; align-items: center; gap: 5px;
            background: rgba(255,255,255,0.08); border-radius: 8px;
            padding: 5px 10px; font-size: 0.65rem; font-weight: 700;
            letter-spacing: 1px; cursor: default;
        }
        .ticker-tag button {
            background: none; border: none; color: rgba(255,255,255,0.4);
            cursor: pointer; padding: 0; font-size: 0.8rem; line-height: 1;
            transition: color 0.15s;
        }
        .ticker-tag button:hover { color: #ff4444; }
    </style>
</head>
<body>

<div id="bg-layer"></div>
<div id="overlay" onclick="toggleNav()"></div>
<div id="dim-overlay"></div>
<canvas id="art-canvas" style="display:none;" width="1" height="1"></canvas>

<!-- Keyboard shortcut toast -->
<div id="kb-toast"></div>

<!-- Fullscreen button (bottom-left, fades in on mouse move) -->
<div id="fullscreen-btn" onclick="toggleFullscreen()" title="Fullscreen (F)">
    <svg id="fs-enter-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
    </svg>
    <svg id="fs-exit-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
        <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
    </svg>
</div>

<div id="confirm-modal">
    <div class="modal-box">
        <h3>Reset System?</h3>
        <p>This will permanently delete all saved themes and background settings.</p>
        <button class="modal-btn" style="background:#ff4444;color:#fff;" onclick="performFactoryReset()">RESET EVERYTHING</button>
        <button class="modal-btn" style="background:rgba(255,255,255,0.1);color:#fff;" onclick="closeModal()">CANCEL</button>
    </div>
</div>

<!-- ‚îÄ‚îÄ HUD ‚îÄ‚îÄ -->
<div id="hud-master">
    <div id="clock-widget" class="widget">
        <div class="widget-pill" style="display:flex;flex-direction:column;align-items:center;">
            <div id="clock" class="style-bold">0:00</div>
            <svg id="analog-clock" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <circle class="a-face" cx="100" cy="100" r="96"/>
                <g id="a-ticks"></g>
                <line id="a-hour" class="a-hour" x1="100" y1="100" x2="100" y2="45"/>
                <line id="a-min"  class="a-min"  x1="100" y1="100" x2="100" y2="28"/>
                <line id="a-sec"  class="a-sec"  x1="100" y1="115" x2="100" y2="20"/>
                <circle class="a-center" cx="100" cy="100" r="4"/>
            </svg>
        </div>
    </div>
    <div id="date-widget" class="widget"><div class="widget-pill"><div id="date">...</div></div></div>
    <div id="weather-widget" class="widget">
        <div class="widget-pill" style="display:flex;gap:20px;align-items:center;">
            <div id="icon-container"></div>
            <span id="temp">--¬∞</span>
        </div>
    </div>
    <div id="battery-widget" class="widget">
        <div class="widget-pill" style="display:flex;align-items:center;gap:12px;">
            <div id="battery-icon"></div>
            <div id="battery">--%</div>
        </div>
    </div>
    <div id="nowplaying-widget" class="widget" style="display:none;">
        <div class="widget-pill" style="display:flex;flex-direction:row;gap:14px;align-items:center;max-width:380px;">
            <div id="np-art">‚ô´</div>
            <div id="np-info">
                <div id="np-track">Nothing playing</div>
                <div id="np-artist">‚Äî</div>
                <div id="np-controls">
                    <button class="np-btn" onclick="spotifyPrev()" title="Previous">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
                    </button>
                    <button class="np-btn" id="np-playpause" onclick="spotifyPlayPause()" title="Play/Pause">
                        <svg id="np-play-icon" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="np-pause-icon" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <button class="np-btn" onclick="spotifyNext()" title="Next">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zm2-8.14 5.15 3.64L8 17.14V9.86zM16 6h2v12h-2z"/></svg>
                    </button>
                    <div>
                        <div id="np-bar"><div id="np-bar-fill"></div></div>
                        <div class="np-premium-note">Requires Spotify Premium</div>
                    </div>
                </div>
                <div id="np-label">SPOTIFY</div>
            </div>
        </div>
    </div>
    <div id="stocks-widget" class="widget" style="display:none;">
        <div class="widget-pill">
            <div id="stocks-list"><!-- rows injected by JS --></div>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ NAV BUTTON ‚îÄ‚îÄ -->
<div id="nav-ghost-zone" onmousemove="wakeNav()" onclick="wakeNav()"></div>
<div id="nav-trigger" onclick="toggleNav(event)">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
    </svg>
</div>

<!-- ‚îÄ‚îÄ SIDE PANEL ‚îÄ‚îÄ -->
<div id="side-panel">
    <div class="panel-content">
        <h2 style="margin:0;font-size:1.5rem;font-weight:900;">Settings</h2>

        <!-- Theme Manager -->
        <div class="control-group">
            <label>Theme Manager</label>
            <div style="display:flex;gap:10px;">
                <input type="text" id="theme-name" placeholder="Save as..." style="margin-top:10px;flex-grow:1;">
                <button onclick="saveTheme()" class="update-btn" style="width:auto;padding:0 20px;margin-top:10px;">SAVE</button>
            </div>
            <div id="theme-list" style="margin-top:15px;"></div>
        </div>

        <!-- Clock Style + Settings -->
        <div class="control-group">
            <div class="row"><label>Clock Widget</label><span class="reset-link" onclick="resetWidget('clock')">Reset Position</span></div>
            <div class="style-grid" style="margin-top:12px;">
                <div class="style-btn active" data-style="bold"   onclick="setClockStyle('bold')">  <span class="s-icon">ùóú</span>Bold</div>
                <div class="style-btn"        data-style="thin"   onclick="setClockStyle('thin')">  <span class="s-icon">I</span>Thin</div>
                <div class="style-btn"        data-style="retro"  onclick="setClockStyle('retro')"> <span class="s-icon">8Ã§</span>Retro</div>
                <div class="style-btn"        data-style="analog" onclick="setClockStyle('analog')"><span class="s-icon">‚ó∑</span>Analog</div>
            </div>
            <div class="row" style="margin-top:14px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.06);">
                <label style="font-size:0.5rem;">Show Seconds</label>
                <div id="sw-showSeconds" class="ios-switch" onclick="toggle('showSeconds')"></div>
            </div>
            <div class="row" style="margin-top:10px;">
                <label style="font-size:0.5rem;">Visibility</label>
                <div style="display:flex;align-items:center;"><span id="st-clock" class="status-tag">SHOWN</span><div id="sw-showClock" class="ios-switch active" onclick="toggle('showClock')"></div></div>
            </div>
        </div>

        <!-- Ambient Sound -->
        <div class="control-group">
            <div class="row"><label>Ambient Sound</label><span id="amb-status" class="status-tag off">OFF</span></div>
            <div class="ambient-grid">
                <div class="ambient-btn" data-sound="white" onclick="toggleAmbient('white')"><span class="a-icon">üå´Ô∏è</span>White</div>
                <div class="ambient-btn" data-sound="pink"  onclick="toggleAmbient('pink')"> <span class="a-icon">üå∏</span>Pink</div>
                <div class="ambient-btn" data-sound="brown" onclick="toggleAmbient('brown')"><span class="a-icon">üåä</span>Brown</div>
                <div class="ambient-btn" data-sound="rain"  onclick="toggleAmbient('rain')"> <span class="a-icon">üåßÔ∏è</span>Rain</div>
            </div>
            <div class="vol-row">
                <label>VOL</label>
                <input type="range" min="0" max="1" step="0.02" value="0.3" id="amb-vol" oninput="setAmbientVolume(this.value)">
            </div>
        </div>

        <!-- Spotify + Now Playing (combined) -->
        <div class="control-group">
            <div class="row">
                <label>Spotify Now Playing</label>
                <span class="reset-link" onclick="resetWidget('nowplaying')">Reset Position</span>
            </div>
            <div id="spotify-status-row" style="margin-top:10px;"></div>
            <button onclick="connectSpotify()" class="update-btn" style="background:#1DB954;color:#fff;margin-top:10px;">CONNECT SPOTIFY</button>
            <button onclick="disconnectSpotify()" class="update-btn" style="background:rgba(255,255,255,0.08);color:#fff;margin-top:6px;" id="spotify-disconnect-btn">DISCONNECT</button>
            <div style="margin-top:14px; padding-top:14px; border-top:1px solid rgba(255,255,255,0.06);">
                <div class="row">
                    <label style="font-size:0.5rem;">Album Art as Background</label>
                    <div id="sw-artAsBg" class="ios-switch" onclick="toggle('artAsBg')"></div>
                </div>
                <div class="row" style="margin-top:10px;">
                    <label style="font-size:0.5rem;">Visibility</label>
                    <div style="display:flex;align-items:center;">
                        <span id="st-nowplaying" class="status-tag">SHOWN</span>
                        <div id="sw-showNowplaying" class="ios-switch active" onclick="toggle('showNowplaying')"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weather -->
        <div class="control-group">
            <div class="row"><label>Weather Widget</label><span class="reset-link" onclick="resetWidget('weather')">Reset Position</span></div>
            <input type="text" id="city-input" placeholder="Search City..." oninput="searchCities(this.value)" style="margin-top:10px;">
            <div id="weather-results"></div>
            <div class="row" style="margin-top:14px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.06);">
                <label style="font-size:0.5rem;">Units</label>
                <div style="display:flex;gap:6px;">
                    <div id="unit-c" class="style-btn active" style="padding:6px 14px;font-size:0.6rem;" onclick="setWeatherUnit('C')">¬∞C</div>
                    <div id="unit-f" class="style-btn"        style="padding:6px 14px;font-size:0.6rem;" onclick="setWeatherUnit('F')">¬∞F</div>
                </div>
            </div>
            <div class="row" style="margin-top:10px;">
                <label style="font-size:0.5rem;">Visibility</label>
                <div style="display:flex;align-items:center;"><span id="st-weather" class="status-tag">SHOWN</span><div id="sw-showWeather" class="ios-switch active" onclick="toggle('showWeather')"></div></div>
            </div>
        </div>

        <!-- Background -->
        <div class="control-group">
            <label>Background</label>
            <label for="bg-upload" class="file-upload-btn" style="margin-top:15px;">CHOOSE FILE</label>
            <input type="file" id="bg-upload" style="display:none;" onchange="handleBg(this)">
            <div class="wallpaper-grid">
                <div id="static-bg-preview"><input type="color" id="static-bg-picker" oninput="setStatic(this.value)"></div>
                <div id="bg-history" style="display:contents;"></div>
            </div>
        </div>

        <!-- BG Effects -->
        <div class="control-group">
            <label>Background Effects</label>
            <div class="row" style="margin-top:15px;"><label style="font-size:0.5rem;">Blur</label></div>
            <input type="range" min="0" max="40" step="1" value="0" oninput="state.blur=this.value;applyAll();save();">
            <div class="row" style="margin-top:10px;"><label style="font-size:0.5rem;">Opacity</label></div>
            <input type="range" min="0" max="1" step="0.01" value="1" oninput="state.bgOpacity=this.value;applyAll();save();">
        </div>

        <!-- Toggles -->
        <div class="control-group">
            <div class="row"><label>OLED Burn Shield</label><div id="sw-burnShield" class="ios-switch" onclick="toggle('burnShield')"></div></div>
            <div class="row" style="margin-top:10px;"><label>Flip Widgets</label><div id="sw-mirrored" class="ios-switch" onclick="toggle('mirrored')"></div></div>
            <div class="row" style="margin-top:10px;"><label>24 Hour Time</label><div id="sw-is24h" class="ios-switch" onclick="toggle('is24h')"></div></div>
            <div class="row" style="margin-top:10px;"><label>Widget Background Pill</label><div id="sw-showPills" class="ios-switch" onclick="toggle('showPills')"></div></div>
        </div>

        <!-- Date Widget -->
        <div class="control-group">
            <div class="row"><label>Date Widget</label><span class="reset-link" onclick="resetWidget('date')">Reset Position</span></div>
            <div class="row" style="margin-top:10px;"><label style="font-size:0.5rem;">Visibility</label>
                <div style="display:flex;align-items:center;"><span id="st-date" class="status-tag">SHOWN</span><div id="sw-showDate" class="ios-switch active" onclick="toggle('showDate')"></div></div>
            </div>
        </div>

        <!-- Battery Widget -->
        <div class="control-group">
            <div class="row"><label>Battery Widget</label><span class="reset-link" onclick="resetWidget('battery')">Reset Position</span></div>
            <div class="row" style="margin-top:10px;"><label style="font-size:0.5rem;">Visibility</label>
                <div style="display:flex;align-items:center;"><span id="st-battery" class="status-tag">SHOWN</span><div id="sw-showBattery" class="ios-switch active" onclick="toggle('showBattery')"></div></div>
            </div>
        </div>

        <!-- Stocks Widget -->
        <div class="control-group">
            <div class="row"><label>Stocks Widget</label><span class="reset-link" onclick="resetWidget('stocks')">Reset Position</span></div>
            <div class="row" style="margin-top:10px;">
                <label style="font-size:0.5rem;">Visibility</label>
                <div style="display:flex;align-items:center;"><span id="st-stocks" class="status-tag">HIDDEN</span><div id="sw-showStocks" class="ios-switch" onclick="toggle('showStocks')"></div></div>
            </div>
            <div style="margin-top:14px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.06);">
                <label style="font-size:0.5rem;">Tickers</label>
                <div id="ticker-tags" class="ticker-tags"></div>
                <div style="display:flex;gap:8px;margin-top:10px;">
                    <input type="text" id="ticker-input" placeholder="e.g. AAPL" style="margin-top:0;text-transform:uppercase;flex:1;" maxlength="10" oninput="this.value=this.value.toUpperCase()">
                    <button onclick="addTicker()" class="update-btn" style="width:auto;padding:0 16px;margin-top:0;">ADD</button>
                </div>
            </div>
        </div>

        <div class="control-group">
            <div class="row"><label>Widget Scale</label></div>
            <input type="range" id="range-scale" min="0.4" max="2.0" step="0.01" value="1" oninput="state.scale=this.value;applyAll();save();">
        </div>

        <div class="control-group">
            <label>Accent Color</label>
            <input type="color" id="color-accent" style="height:45px;width:100%;border:none;background:none;" onchange="state.accent=this.value;applyAll();save();">
        </div>

        <button onclick="openModal()" class="factory-reset-btn">FACTORY RESET</button>
    </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
    mirrored: false, is24h: true, burnShield: true,
    showClock: true, showDate: true, showWeather: true, showBattery: true, showNowplaying: true, showStocks: false,
    showSeconds: false, weatherUnit: 'C', artAsBg: false, showPills: false,
    tickers: ['AAPL', 'TSLA', 'NVDA'],
    widgetPos: {
        clock:      { x: 50, y: 25 },
        date:       { x: 50, y: 50 },
        weather:    { x: 50, y: 75 },
        battery:    { x: 83, y: 6  },
        nowplaying: { x: 50, y: 94 },
        stocks:     { x: 17, y: 50 }
    },
    scale: 1, accent: '#007AFF',
    city: 'Calgary', bg: '', history: [],
    isStatic: false, staticColor: '#000000', blur: 0, bgOpacity: 1,
    presets: {},
    clockStyle: 'bold',
    ambientSound: null, ambientVolume: 0.3,
    spotifyClientId: ''
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PERSIST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function save() { localStorage.setItem('prism_ultra_v3', JSON.stringify(state)); }

function load() {
    const saved = localStorage.getItem('prism_ultra_v3');
    if (saved) state = Object.assign(state, JSON.parse(saved));

    // Handle Spotify OAuth callback
    handleSpotifyCallback();

    applyAll();
    renderHistory();
    renderThemeList();
    updateClock();
    updateBattery();
    fetchWeather();
    startBurnShield();
    drawAnalogTicks();
    wakeNav();
    updateSpotifyUI();

    if (state.spotifyClientId && spotify.accessToken) {
        document.getElementById('nowplaying-widget').style.display = 'flex';
        pollSpotify();
    }

    resetDimTimer();
    createSnapGhosts();
    initAllDrag();

    // Stocks
    if (state.showStocks) {
        document.getElementById('stocks-widget').style.display = 'flex';
        startStocksPolling();
    }
    renderTickerTags();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NAV
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let navTimer;
function wakeNav() {
    const btn = document.getElementById('nav-trigger');
    const fsBtn = document.getElementById('fullscreen-btn');
    btn.style.opacity = '0.6';
    fsBtn.style.opacity = '0.5';
    clearTimeout(navTimer);
    navTimer = setTimeout(() => {
        if (!document.getElementById('side-panel').classList.contains('open')) {
            btn.style.opacity = '0';
            fsBtn.style.opacity = '0';
        }
    }, 3000);
}

function toggleNav(e) {
    if (e) e.stopPropagation();
    const panel = document.getElementById('side-panel');
    const isOpen = panel.classList.toggle('open');
    document.getElementById('overlay').style.display = isOpen ? 'block' : 'none';
    if (isOpen) {
        clearTimeout(navTimer);
        document.getElementById('nav-trigger').style.opacity = '1';
    } else { wakeNav(); }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FULLSCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(() => {});
    } else {
        document.exitFullscreen().catch(() => {});
    }
}

document.addEventListener('fullscreenchange', () => {
    const isFs = !!document.fullscreenElement;
    document.getElementById('fs-enter-icon').style.display = isFs ? 'none'  : 'block';
    document.getElementById('fs-exit-icon').style.display  = isFs ? 'block' : 'none';
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AUTO-DIM ON INACTIVITY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dim = { timer: null, isDimmed: false, DELAY_MS: 3 * 60 * 1000 }; // 3 min

function resetDimTimer() {
    if (dim.isDimmed) undim();
    clearTimeout(dim.timer);
    dim.timer = setTimeout(doDim, dim.DELAY_MS);
}

function doDim() {
    dim.isDimmed = true;
    document.getElementById('dim-overlay').classList.add('dimmed');
}

function undim() {
    dim.isDimmed = false;
    document.getElementById('dim-overlay').classList.remove('dimmed');
}

['mousemove', 'mousedown', 'keydown', 'touchstart', 'scroll'].forEach(evt =>
    document.addEventListener(evt, resetDimTimer, { passive: true })
);
document.addEventListener('mousemove', wakeNav, { passive: true });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// KEYBOARD SHORTCUTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function showToast(msg) {
    const t = document.getElementById('kb-toast');
    t.innerText = msg;
    t.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove('show'), 1800);
}

document.addEventListener('keydown', e => {
    // Don't fire if user is typing in an input
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    switch (e.key) {
        case ' ':
        case 'k':
            e.preventDefault();
            spotifyPlayPause();
            showToast('‚èØ  Play / Pause');
            break;
        case 'ArrowRight':
        case 'l':
            spotifyNext();
            showToast('‚è≠  Next Track');
            break;
        case 'ArrowLeft':
        case 'j':
            spotifyPrev();
            showToast('‚èÆ  Previous Track');
            break;
        case 'f':
        case 'F':
            toggleFullscreen();
            showToast(document.fullscreenElement ? '‚§°  Exit Fullscreen' : '‚§¢  Fullscreen');
            break;
        case 'Escape':
            if (document.getElementById('side-panel').classList.contains('open')) toggleNav();
            break;
        case 'd':
            if (dim.isDimmed) { undim(); clearTimeout(dim.timer); } else doDim();
            showToast(dim.isDimmed ? 'üåô  Dimmed' : '‚òÄÔ∏é  Undimmed');
            break;
    }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ALBUM ART ACCENT COLOR EXTRACTION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let accentFromArt = false; // track whether accent is from art or user setting

function extractAccentFromArt(imgUrl) {
    if (!imgUrl) { restoreUserAccent(); return; }
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
        try {
            const canvas = document.getElementById('art-canvas');
            const ctx    = canvas.getContext('2d');
            // Downsample to 1√ó1 for a very fast average ‚Äî gives the dominant tone
            canvas.width = 50; canvas.height = 50;
            ctx.drawImage(img, 0, 0, 50, 50);
            const data = ctx.getImageData(0, 0, 50, 50).data;

            // Weighted sample: favour saturated pixels over grey ones
            let rSum = 0, gSum = 0, bSum = 0, weight = 0;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                const sat = max === 0 ? 0 : (max - min) / max;
                const lum = (max + min) / 510;
                // Ignore near-black, near-white, and grey pixels
                if (sat < 0.25 || lum < 0.12 || lum > 0.88) continue;
                const w = sat * sat; // square weight to really prefer saturated colours
                rSum += r * w; gSum += g * w; bSum += b * w; weight += w;
            }
            if (weight === 0) { restoreUserAccent(); return; }

            let r = Math.round(rSum / weight);
            let g = Math.round(gSum / weight);
            let b = Math.round(bSum / weight);

            // Boost saturation so it feels vivid on the dark background
            const max = Math.max(r, g, b), min2 = Math.min(r, g, b), delta = max - min2;
            if (delta > 0) {
                const factor = 1.4;
                const mid = (max + min2) / 2;
                r = Math.round(mid + (r - mid) * factor);
                g = Math.round(mid + (g - mid) * factor);
                b = Math.round(mid + (b - mid) * factor);
                r = Math.min(255, Math.max(0, r));
                g = Math.min(255, Math.max(0, g));
                b = Math.min(255, Math.max(0, b));
            }

            const hex = '#' + [r, g, b].map(v => v.toString(16).padStart(2, '0')).join('');
            accentFromArt = true;
            document.documentElement.style.setProperty('--accent', hex);
            // Recompute fg contrast for the new art-derived accent
            const lum2 = (0.299*r + 0.587*g + 0.114*b) / 255;
            document.documentElement.style.setProperty('--accent-fg', lum2 > 0.65 ? '#111' : '#fff');
            // Album art as background
            if (state.artAsBg && imgUrl) {
                const bgl = document.getElementById('bg-layer');
                bgl.style.backgroundImage = `url(${imgUrl})`;
                document.body.style.backgroundColor = '#000';
            }
        } catch (err) { restoreUserAccent(); }
    };
    img.onerror = () => restoreUserAccent();
    img.src = imgUrl;
}

function restoreUserAccent() {
    accentFromArt = false;
    document.documentElement.style.setProperty('--accent', state.accent);
    // Also recompute fg contrast for user accent
    const hex = state.accent.replace('#','');
    const r = parseInt(hex.slice(0,2),16), g = parseInt(hex.slice(2,4),16), b = parseInt(hex.slice(4,6),16);
    const lum = (0.299*r + 0.587*g + 0.114*b) / 255;
    document.documentElement.style.setProperty('--accent-fg', lum > 0.65 ? '#111' : '#fff');
    // Restore user background
    if (state.artAsBg) {
        const bgl = document.getElementById('bg-layer');
        bgl.style.backgroundImage = state.isStatic ? 'none' : `url(${state.bg})`;
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CLOCK
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateClock() {
    const now = new Date();
    let h = now.getHours();
    const m = String(now.getMinutes()).padStart(2, '0');
    const s = String(now.getSeconds()).padStart(2, '0');
    if (!state.is24h) h = h % 12 || 12;
    const timeStr = state.showSeconds ? `${h}:${m}:${s}` : `${h}:${m}`;
    document.getElementById('clock').innerText = timeStr;
    document.getElementById('date').innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: '2-digit' }).toUpperCase();
    updateAnalogClock(now);
}
setInterval(updateClock, 1000);

// DOM-only clock style update ‚Äî safe to call from applyAll()
function applyClockStyle(style) {
    document.querySelectorAll('.style-btn').forEach(b => b.classList.toggle('active', b.dataset.style === style));
    const clockEl  = document.getElementById('clock');
    const analogEl = document.getElementById('analog-clock');
    const isAnalog = style === 'analog';
    clockEl.style.display  = isAnalog ? 'none' : 'block';
    analogEl.style.display = isAnalog ? 'block' : 'none';
    if (!isAnalog) clockEl.className = `style-${style}`;
}

// Public setter called from UI buttons ‚Äî saves state then applies
function setClockStyle(style) {
    state.clockStyle = style;
    applyClockStyle(style);
    save();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ANALOG CLOCK
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawAnalogTicks() {
    const g = document.getElementById('a-ticks');
    g.innerHTML = '';
    for (let i = 0; i < 60; i++) {
        const angle = (i * 6 - 90) * Math.PI / 180;
        const isMajor = i % 5 === 0;
        const r1 = isMajor ? 78 : 86, r2 = 93;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', 100 + r1 * Math.cos(angle));
        line.setAttribute('y1', 100 + r1 * Math.sin(angle));
        line.setAttribute('x2', 100 + r2 * Math.cos(angle));
        line.setAttribute('y2', 100 + r2 * Math.sin(angle));
        line.setAttribute('class', isMajor ? 'a-tick-major' : 'a-tick');
        g.appendChild(line);
    }
}

function updateAnalogClock(now) {
    if (state.clockStyle !== 'analog') return;
    const s  = now.getSeconds();
    const mn = now.getMinutes();
    const h  = now.getHours() % 12;
    const setHand = (id, angle, len) => {
        const rad = (angle - 90) * Math.PI / 180;
        document.getElementById(id).setAttribute('x2', 100 + len * Math.cos(rad));
        document.getElementById(id).setAttribute('y2', 100 + len * Math.sin(rad));
    };
    setHand('a-hour', (h * 30) + (mn * 0.5), 55);
    setHand('a-min',  mn * 6, 72);
    setHand('a-sec',  s * 6, 80);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// WEATHER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const icons = {
    sun: `<svg width="40" height="40" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>`,
    cloud: `<svg width="40" height="40" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>`,
    rain: `<svg width="40" height="40" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M16 13v8M8 13v8M12 15v8M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg>`,
    snow: `<svg width="40" height="40" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25M8 16h.01M8 20h.01M12 18h.01M12 22h.01M16 16h.01M16 20h.01"></path></svg>`,
    storm: `<svg width="40" height="40" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9M13 11l-4 6h6l-4 6"></path></svg>`
};

async function searchCities(query) {
    const box = document.getElementById('weather-results');
    if (query.length < 2) { box.style.display = 'none'; return; }
    try {
        const res  = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=5&language=en&format=json`);
        const data = await res.json();
        if (data.results) {
            box.innerHTML = '';
            data.results.forEach(city => {
                const div = document.createElement('div');
                div.className = 'city-item';
                div.innerHTML = `${city.name} <span>${city.admin1 || ''}, ${city.country_code.toUpperCase()}</span>`;
                div.onclick = () => selectCity(city.name);
                box.appendChild(div);
            });
            box.style.display = 'block';
        } else { box.style.display = 'none'; }
    } catch (e) { console.error(e); }
}

function selectCity(name) {
    state.city = name;
    document.getElementById('city-input').value = name;
    document.getElementById('weather-results').style.display = 'none';
    fetchWeather(); save();
}

async function fetchWeather() {
    try {
        const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(state.city)}&count=1`).then(r => r.json());
        if (!geo.results) return;
        const { latitude, longitude } = geo.results[0];
        const unit = state.weatherUnit === 'F' ? 'fahrenheit' : 'celsius';
        const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&temperature_unit=${unit}`).then(r => r.json());
        document.getElementById('temp').innerText = Math.round(w.current.temperature_2m) + '¬∞' + state.weatherUnit;
        const code = w.current.weather_code;
        let icon = icons.sun;
        if (code >= 1 && code <= 3)   icon = icons.cloud;
        else if (code >= 45 && code <= 67) icon = icons.rain;
        else if (code >= 71 && code <= 86) icon = icons.snow;
        else if (code >= 95)           icon = icons.storm;
        document.getElementById('icon-container').innerHTML = icon;
    } catch (e) {}
}

function setWeatherUnit(unit) {
    state.weatherUnit = unit;
    document.getElementById('unit-c').classList.toggle('active', unit === 'C');
    document.getElementById('unit-f').classList.toggle('active', unit === 'F');
    fetchWeather(); save();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BATTERY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const batIcons = {
    bolt: `<path d="M12 7l-3.5 5h3l-1 5 4.5-6.5h-3l1-3.5z" fill="white" stroke="rgba(0,0,0,0.3)" stroke-width="0.3"/>`,
    frame: `<rect x="2" y="7" width="16" height="10" rx="3" stroke="currentColor" fill="none" stroke-width="1.5" opacity="0.6"/><path d="M19 10.5c1 0 1 3 0 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>`
};

async function updateBattery() {
    try {
        const b = await navigator.getBattery();
        const updateUI = () => {
            const level = Math.round(b.level * 100);
            const isCharging = b.charging;
            const fillWidth = (level / 100) * 13;
            let fillColor = state.accent;
            if (level <= 20) fillColor = '#ff4444';
            if (level === 100) fillColor = '#34C759';
            let svg = `<svg width="34" height="34" viewBox="0 0 24 24" fill="none" style="filter:drop-shadow(0 0 2px rgba(0,0,0,0.5))">`;
            svg += batIcons.frame;
            svg += `<rect x="3.5" y="8.5" width="${fillWidth}" height="7" rx="1.5" fill="${fillColor}"/>`;
            if (isCharging) svg += batIcons.bolt;
            svg += `</svg>`;
            document.getElementById('battery-icon').innerHTML = svg;
            const bt = document.getElementById('battery');
            bt.innerText = level + '%';
            bt.classList.toggle('charging-pulse', isCharging);
        };
        updateUI();
        b.onlevelchange = updateUI;
        b.onchargingchange = updateUI;
    } catch (e) { document.getElementById('battery-widget').style.display = 'none'; }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STOCKS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let stocksRefreshTimer = null;

async function fetchStocks() {
    if (!state.tickers || state.tickers.length === 0) return;
    const list = document.getElementById('stocks-list');
    if (!list) return;

    // Fetch each ticker individually via Yahoo Finance v8 chart endpoint
    // Try multiple CORS proxies in order until one works
    const PROXIES = [
        url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        url => `https://corsproxy.io/?url=${encodeURIComponent(url)}`,
        url => `https://thingproxy.freeboard.io/fetch/${url}`,
    ];

    async function fetchTicker(symbol) {
        const target = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=2d`;
        for (const makeUrl of PROXIES) {
            try {
                const res = await fetch(makeUrl(target), { signal: AbortSignal.timeout(6000) });
                if (!res.ok) continue;
                const json = await res.json();
                const meta = json?.chart?.result?.[0]?.meta;
                if (!meta) continue;
                const price  = meta.regularMarketPrice;
                const prev   = meta.chartPreviousClose ?? meta.previousClose;
                const change = price - prev;
                const pct    = (change / prev) * 100;
                return { symbol, price, change, pct, ok: true };
            } catch (_) { continue; }
        }
        return { symbol, ok: false };
    }

    // Show loading state
    list.innerHTML = state.tickers.map(t =>
        `<div class="stock-row"><span class="stock-ticker">${t}</span><span class="stock-price" style="opacity:0.3">‚Ä¶</span></div>`
    ).join('');

    // Fetch all tickers in parallel
    const results = await Promise.all(state.tickers.map(fetchTicker));

    list.innerHTML = '';
    let anyOk = false;
    results.forEach((q, i) => {
        const row = document.createElement('div');
        row.className = 'stock-row';
        if (q.ok) {
            anyOk = true;
            const up   = q.change >= 0;
            const sign = up ? '+' : '';
            const cls  = up ? 'up' : 'down';
            const arrow = up ? '‚ñ≤' : '‚ñº';
            row.innerHTML = `
                <span class="stock-ticker">${q.symbol}</span>
                <span class="stock-price">$${q.price.toFixed(2)}</span>
                <span class="stock-change ${cls}">${arrow} ${sign}${q.pct.toFixed(2)}%</span>
            `;
        } else {
            row.innerHTML = `
                <span class="stock-ticker">${q.symbol}</span>
                <span class="stock-price" style="opacity:0.35">N/A</span>
                <span class="stock-change" style="opacity:0.3">‚Äî</span>
            `;
        }
        list.appendChild(row);
        if (i < results.length - 1) {
            const div = document.createElement('div');
            div.className = 'stock-divider';
            list.appendChild(div);
        }
    });
}

function renderStockError() {
    const list = document.getElementById('stocks-list');
    if (list) list.innerHTML = `<div style="font-size:0.65rem;opacity:0.4;text-align:center;padding:6px 0;">Unable to load</div>`;
}

function startStocksPolling() {
    clearInterval(stocksRefreshTimer);
    fetchStocks();
    stocksRefreshTimer = setInterval(fetchStocks, 60000); // refresh every minute
}

function renderTickerTags() {
    const container = document.getElementById('ticker-tags');
    if (!container) return;
    if (!state.tickers) state.tickers = [];
    container.innerHTML = '';
    state.tickers.forEach(t => {
        const tag = document.createElement('div');
        tag.className = 'ticker-tag';
        tag.innerHTML = `<span>${t}</span><button onclick="removeTicker('${t}')" title="Remove">‚úï</button>`;
        container.appendChild(tag);
    });
}

function addTicker() {
    const input = document.getElementById('ticker-input');
    const val = input.value.trim().toUpperCase();
    if (!val || val.length > 10) return;
    if (!state.tickers) state.tickers = [];
    if (state.tickers.includes(val)) { input.value = ''; return; }
    state.tickers.push(val);
    input.value = '';
    renderTickerTags();
    save();
    if (state.showStocks) fetchStocks();
}

function removeTicker(t) {
    state.tickers = state.tickers.filter(x => x !== t);
    renderTickerTags();
    save();
    if (state.showStocks) fetchStocks();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AMBIENT SOUND ‚Äî high quality Web Audio engine
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ambient = { ctx: null, gainNode: null, active: null, stoppers: [] };

function ensureCtx() {
    if (!ambient.ctx) ambient.ctx = new (window.AudioContext || window.webkitAudioContext)();
    if (ambient.ctx.state === 'suspended') ambient.ctx.resume();
}

// Master gain + compressor so nothing ever clips or sounds harsh
function makeMaster() {
    const ctx = ambient.ctx;
    const gain = ctx.createGain();
    gain.gain.value = state.ambientVolume;
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value = -18;
    comp.knee.value       = 12;
    comp.ratio.value      = 4;
    comp.attack.value     = 0.1;
    comp.release.value    = 0.4;
    gain.connect(comp);
    comp.connect(ctx.destination);
    ambient.gainNode = gain;
}

// Fill a buffer with white noise samples
function whiteNoiseBuf(seconds) {
    const ctx = ambient.ctx;
    const buf = ctx.createBuffer(2, ctx.sampleRate * seconds, ctx.sampleRate);
    for (let ch = 0; ch < 2; ch++) {
        const d = buf.getChannelData(ch);
        for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;
    }
    return buf;
}

// Looping buffer source helper
function loopSource(buf) {
    const src = ambient.ctx.createBufferSource();
    src.buffer = buf;
    src.loop = true;
    return src;
}

// Procedural reverb impulse response
function makeReverb(duration = 2.0, decay = 3.0) {
    const ctx = ambient.ctx;
    const len = ctx.sampleRate * duration;
    const buf = ctx.createBuffer(2, len, ctx.sampleRate);
    for (let ch = 0; ch < 2; ch++) {
        const d = buf.getChannelData(ch);
        for (let i = 0; i < len; i++) {
            d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, decay);
        }
    }
    const conv = ctx.createConvolver();
    conv.buffer = buf;
    return conv;
}

// Stop all currently running sound nodes
function stopAmbient() {
    ambient.stoppers.forEach(fn => { try { fn(); } catch (e) {} });
    ambient.stoppers = [];
    if (ambient.gainNode) { ambient.gainNode.disconnect(); ambient.gainNode = null; }
}

function playAmbient(type) {
    ensureCtx();
    stopAmbient();
    makeMaster();
    const ctx = ambient.ctx;
    const out = ambient.gainNode;
    const sr  = ctx.sampleRate;

    // ‚îÄ‚îÄ WHITE NOISE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (type === 'white') {
        const src = loopSource(whiteNoiseBuf(4));
        // Gentle shelving: remove harshness above 6 kHz
        const lp = ctx.createBiquadFilter();
        lp.type = 'lowpass'; lp.frequency.value = 6000; lp.Q.value = 0.5;
        // Also roll off the very low end so it's clean air, not rumble
        const hp = ctx.createBiquadFilter();
        hp.type = 'highpass'; hp.frequency.value = 120; hp.Q.value = 0.5;
        src.connect(hp); hp.connect(lp); lp.connect(out);
        src.start();
        ambient.stoppers.push(() => src.stop());

    // ‚îÄ‚îÄ PINK NOISE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    } else if (type === 'pink') {
        // Generate pink noise offline using Paul Kellett's filter
        const bufSize = sr * 4;
        const raw = new Float32Array(bufSize);
        let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
        for (let i = 0; i < bufSize; i++) {
            const w = Math.random() * 2 - 1;
            b0 = 0.99886*b0 + w*0.0555179; b1 = 0.99332*b1 + w*0.0750759;
            b2 = 0.96900*b2 + w*0.1538520; b3 = 0.86650*b3 + w*0.3104856;
            b4 = 0.55000*b4 + w*0.5329522; b5 = -0.7616*b5 - w*0.0168980;
            raw[i] = (b0+b1+b2+b3+b4+b5+b6+w*0.5362) / 7.5; // normalised
            b6 = w * 0.115926;
        }
        // Stereo: slightly decorrelated second channel
        const buf = ctx.createBuffer(2, bufSize, sr);
        buf.getChannelData(0).set(raw);
        // Offset channel 1 by a few ms for natural width
        const offset = Math.floor(sr * 0.007);
        buf.getChannelData(1).set(raw.subarray(offset));

        const src = loopSource(buf);
        // Soft shelf: take the edge off highs above 5 kHz
        const lp = ctx.createBiquadFilter();
        lp.type = 'lowshelf'; lp.frequency.value = 5000; lp.gain.value = -6;
        src.connect(lp); lp.connect(out);
        src.start();
        ambient.stoppers.push(() => src.stop());

    // ‚îÄ‚îÄ BROWN NOISE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    } else if (type === 'brown') {
        // Brownian (red) noise: integrate white noise samples
        const bufSize = sr * 4;
        const buf = ctx.createBuffer(2, bufSize, sr);
        for (let ch = 0; ch < 2; ch++) {
            const d = buf.getChannelData(ch);
            let last = 0;
            for (let i = 0; i < bufSize; i++) {
                const w = Math.random() * 2 - 1;
                last = (last + 0.02 * w) / 1.02;
                d[i] = last;
            }
            // Normalise to ¬±0.8 so it's not clipped by compressor
            let peak = 0;
            for (let i = 0; i < bufSize; i++) peak = Math.max(peak, Math.abs(d[i]));
            for (let i = 0; i < bufSize; i++) d[i] = d[i] / peak * 0.8;
        }
        const src = loopSource(buf);
        // Aggressive lowpass ‚Äî brown noise should feel like a deep ocean rumble
        const lp1 = ctx.createBiquadFilter();
        lp1.type = 'lowpass'; lp1.frequency.value = 400; lp1.Q.value = 0.4;
        const lp2 = ctx.createBiquadFilter();
        lp2.type = 'lowpass'; lp2.frequency.value = 700; lp2.Q.value = 0.4;
        src.connect(lp1); lp1.connect(lp2); lp2.connect(out);
        src.start();
        ambient.stoppers.push(() => src.stop());

    // ‚îÄ‚îÄ RAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    } else if (type === 'rain') {
        // Shared reverb for the entire rain scene
        const reverb  = makeReverb(1.8, 2.5);
        const revGain = ctx.createGain(); revGain.gain.value = 0.55;
        reverb.connect(revGain); revGain.connect(out);

        // ‚îÄ‚îÄ Layer 1: continuous rain sheet (broadband noise, filtered) ‚îÄ‚îÄ
        const sheet = loopSource(whiteNoiseBuf(6));
        const sheetBp1 = ctx.createBiquadFilter();
        sheetBp1.type = 'bandpass'; sheetBp1.frequency.value = 2200; sheetBp1.Q.value = 0.4;
        const sheetBp2 = ctx.createBiquadFilter();
        sheetBp2.type = 'bandpass'; sheetBp2.frequency.value = 800; sheetBp2.Q.value = 0.5;
        const sheetGain = ctx.createGain(); sheetGain.gain.value = 0.28;
        // Slow LFO (0.08 Hz) gives breathing, undulating quality
        const sheetLFO = ctx.createOscillator(); sheetLFO.frequency.value = 0.08;
        const sheetLFOGain = ctx.createGain(); sheetLFOGain.gain.value = 0.06;
        sheetLFO.connect(sheetLFOGain); sheetLFOGain.connect(sheetGain.gain);
        sheetLFO.start();
        sheet.connect(sheetBp1); sheet.connect(sheetBp2);
        sheetBp1.connect(sheetGain); sheetBp2.connect(sheetGain);
        sheetGain.connect(out); sheetGain.connect(reverb);
        sheet.start();
        ambient.stoppers.push(() => { sheet.stop(); sheetLFO.stop(); });

        // ‚îÄ‚îÄ Layer 2: drizzle texture ‚Äî amplitude-modulated mid noise ‚îÄ‚îÄ
        const drizzle = loopSource(whiteNoiseBuf(5));
        const drizzleBp = ctx.createBiquadFilter();
        drizzleBp.type = 'bandpass'; drizzleBp.frequency.value = 3500; drizzleBp.Q.value = 0.8;
        const drizzleGain = ctx.createGain(); drizzleGain.gain.value = 0.0;
        // Faster LFO (4-7 Hz) creates the "pitter-patter" texture
        const drizzleLFO = ctx.createOscillator(); drizzleLFO.frequency.value = 5.5;
        const drizzleLFOGain = ctx.createGain(); drizzleLFOGain.gain.value = 0.14;
        drizzleLFO.connect(drizzleLFOGain); drizzleLFOGain.connect(drizzleGain.gain);
        drizzleLFO.start();
        drizzle.connect(drizzleBp); drizzleBp.connect(drizzleGain);
        drizzleGain.connect(out); drizzleGain.connect(reverb);
        drizzle.start();
        ambient.stoppers.push(() => { drizzle.stop(); drizzleLFO.stop(); });

        // ‚îÄ‚îÄ Layer 3: low atmospheric rumble (gentle brown tone) ‚îÄ‚îÄ
        const rumbleBuf = ctx.createBuffer(1, sr * 4, sr);
        const rumbleData = rumbleBuf.getChannelData(0);
        let last = 0;
        for (let i = 0; i < rumbleData.length; i++) {
            const w = Math.random() * 2 - 1;
            last = (last + 0.015 * w) / 1.015;
            rumbleData[i] = last;
        }
        const rumble = loopSource(rumbleBuf);
        const rumbleLp = ctx.createBiquadFilter();
        rumbleLp.type = 'lowpass'; rumbleLp.frequency.value = 250; rumbleLp.Q.value = 0.5;
        const rumbleGain = ctx.createGain(); rumbleGain.gain.value = 0.18;
        rumble.connect(rumbleLp); rumbleLp.connect(rumbleGain); rumbleGain.connect(out);
        rumble.start();
        ambient.stoppers.push(() => rumble.stop());

        // ‚îÄ‚îÄ Layer 4: individual drops ‚Äî Poisson-scheduled noise bursts ‚îÄ‚îÄ
        const dropStopped = { v: false };
        function scheduleDrops() {
            if (dropStopped.v) return;
            const sr2 = ctx.sampleRate;
            // Drop length: 30-90ms
            const dropLen = Math.floor(sr2 * (0.03 + Math.random() * 0.06));
            const dropBuf = ctx.createBuffer(1, dropLen, sr2);
            const dd = dropBuf.getChannelData(0);
            for (let i = 0; i < dropLen; i++) {
                // Sharp attack, exponential tail ‚Äî models water droplet impact
                const env = i < 3 ? (i / 3) : Math.pow(1 - (i - 3) / (dropLen - 3), 5);
                dd[i] = (Math.random() * 2 - 1) * env;
            }
            const dropSrc = ctx.createBufferSource();
            dropSrc.buffer = dropBuf;
            const dropBp = ctx.createBiquadFilter();
            dropBp.type = 'bandpass';
            // Each drop has a random "pitch" ‚Äî small drops are higher, large are lower
            dropBp.frequency.value = 300 + Math.random() * 3200;
            dropBp.Q.value = 1.5 + Math.random() * 3;
            const dropGain = ctx.createGain();
            dropGain.gain.value = 0.15 + Math.random() * 0.55;
            dropSrc.connect(dropBp); dropBp.connect(dropGain);
            dropGain.connect(out);       // dry drop click
            dropGain.connect(reverb);    // wet reverb tail (makes it sound like splatter)
            dropSrc.start();
            // Next drop: Poisson arrival ‚Äî avg 40 drops/sec, varies naturally
            const nextMs = 8 + Math.random() * Math.random() * 60;
            setTimeout(scheduleDrops, nextMs);
        }
        scheduleDrops();
        ambient.stoppers.push(() => { dropStopped.v = true; });
    }
}

function toggleAmbient(type) {
    ensureCtx();
    if (ambient.active === type) {
        stopAmbient();
        ambient.active = null;
        state.ambientSound = null;
    } else {
        playAmbient(type);
        ambient.active = type;
        state.ambientSound = type;
    }
    document.querySelectorAll('.ambient-btn').forEach(b => b.classList.toggle('active', b.dataset.sound === ambient.active));
    const statusEl = document.getElementById('amb-status');
    statusEl.innerText = ambient.active ? ambient.active.toUpperCase() : 'OFF';
    statusEl.className = ambient.active ? 'status-tag on' : 'status-tag off';
    save();
}

function setAmbientVolume(v) {
    state.ambientVolume = parseFloat(v);
    if (ambient.gainNode) ambient.gainNode.gain.value = state.ambientVolume;
    save();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SPOTIFY (PKCE ‚Äì fully client-side, works on GitHub Pages)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const spotify = {
    accessToken: null,
    refreshToken: null,
    expiresAt: 0,
    pollInterval: null,
    codeVerifier: null
};

function generateRandomString(len) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    const arr = new Uint8Array(len);
    crypto.getRandomValues(arr);
    arr.forEach(v => result += chars[v % chars.length]);
    return result;
}

async function sha256(plain) {
    const encoded = new TextEncoder().encode(plain);
    const hash    = await crypto.subtle.digest('SHA-256', encoded);
    return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

const SPOTIFY_CLIENT_ID = '34d7e2f46d844a3ab643ab3529b2c9ab';

async function connectSpotify() {
    const clientId = SPOTIFY_CLIENT_ID;
    state.spotifyClientId = clientId;
    save();

    const verifier  = generateRandomString(128);
    const challenge = await sha256(verifier);
    localStorage.setItem('spotify_verifier', verifier);

    const redirectUri = window.location.href.split('?')[0].split('#')[0];
    const params = new URLSearchParams({
        client_id: clientId,
        response_type: 'code',
        redirect_uri: redirectUri,
        scope: 'user-read-currently-playing user-read-playback-state user-modify-playback-state',
        code_challenge_method: 'S256',
        code_challenge: challenge
    });

    window.location = `https://accounts.spotify.com/authorize?${params}`;
}

async function handleSpotifyCallback() {
    const params   = new URLSearchParams(window.location.search);
    const code     = params.get('code');
    const verifier = localStorage.getItem('spotify_verifier');

    if (!code || !verifier || !state.spotifyClientId) return;

    // Clean URL
    history.replaceState({}, '', window.location.pathname);
    localStorage.removeItem('spotify_verifier');

    try {
        const res = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                client_id: state.spotifyClientId,
                grant_type: 'authorization_code',
                code,
                redirect_uri: window.location.href.split('?')[0].split('#')[0],
                code_verifier: verifier
            })
        });
        const data = await res.json();
        if (data.access_token) {
            spotify.accessToken  = data.access_token;
            spotify.refreshToken = data.refresh_token;
            spotify.expiresAt    = Date.now() + data.expires_in * 1000;
            localStorage.setItem('spotify_tokens', JSON.stringify({ a: data.access_token, r: data.refresh_token, e: spotify.expiresAt }));
            document.getElementById('nowplaying-widget').style.display = 'flex';
            updateSpotifyUI();
            pollSpotify();
        }
    } catch (e) { console.error('Spotify auth error', e); }
}

function loadStoredSpotifyTokens() {
    const t = localStorage.getItem('spotify_tokens');
    if (!t) return false;
    const d = JSON.parse(t);
    spotify.accessToken  = d.a;
    spotify.refreshToken = d.r;
    spotify.expiresAt    = d.e;
    return !!spotify.accessToken;
}

async function refreshSpotifyToken() {
    if (!spotify.refreshToken || !state.spotifyClientId) return false;
    try {
        const res = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                client_id: state.spotifyClientId,
                grant_type: 'refresh_token',
                refresh_token: spotify.refreshToken
            })
        });
        const data = await res.json();
        if (data.access_token) {
            spotify.accessToken = data.access_token;
            spotify.expiresAt   = Date.now() + data.expires_in * 1000;
            if (data.refresh_token) spotify.refreshToken = data.refresh_token;
            localStorage.setItem('spotify_tokens', JSON.stringify({ a: spotify.accessToken, r: spotify.refreshToken, e: spotify.expiresAt }));
            return true;
        }
    } catch (e) {}
    return false;
}

async function fetchNowPlaying() {
    if (!spotify.accessToken) return;
    if (Date.now() > spotify.expiresAt - 60000) {
        const ok = await refreshSpotifyToken();
        if (!ok) return;
    }
    try {
        const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
            headers: { Authorization: `Bearer ${spotify.accessToken}` }
        });
        if (res.status === 204 || res.status === 401) {
            updateNowPlayingUI(null);
            return;
        }
        const data = await res.json();
        updateNowPlayingUI(data);
    } catch (e) {}
}

function updateNowPlayingUI(data) {
    if (!data || !data.is_playing && !data.item) {
        document.getElementById('np-track').innerText  = 'Nothing playing';
        document.getElementById('np-artist').innerText = '‚Äî';
        document.getElementById('np-bar-fill').style.width = '0%';
        document.getElementById('np-art').innerHTML    = '‚ô´';
        document.getElementById('np-art').classList.remove('has-art');
        document.getElementById('np-play-icon').style.display  = 'block';
        document.getElementById('np-pause-icon').style.display = 'none';
        return;
    }
    const track = data.item;
    const art   = track.album?.images?.[0]?.url;
    const artEl = document.getElementById('np-art');

    document.getElementById('np-track').innerText  = track.name;
    document.getElementById('np-artist').innerText = track.artists.map(a => a.name).join(', ');

    if (art) {
        artEl.innerHTML = `<img src="${art}" alt="album art">`;
        artEl.classList.add('has-art');
        extractAccentFromArt(art);
    } else {
        artEl.innerHTML = '‚ô´';
        artEl.classList.remove('has-art');
        restoreUserAccent();
    }

    const pct = data.progress_ms / track.duration_ms * 100;
    document.getElementById('np-bar-fill').style.width = pct + '%';

    // Toggle play/pause icon
    const isPlaying = data.is_playing;
    document.getElementById('np-play-icon').style.display  = isPlaying ? 'none'  : 'block';
    document.getElementById('np-pause-icon').style.display = isPlaying ? 'block' : 'none';
}

// ‚îÄ‚îÄ Playback controls (requires Spotify Premium) ‚îÄ‚îÄ
async function spotifyControl(method, endpoint) {
    if (!spotify.accessToken) return;
    if (Date.now() > spotify.expiresAt - 60000) await refreshSpotifyToken();
    try {
        await fetch(`https://api.spotify.com/v1/me/player/${endpoint}`, {
            method,
            headers: { Authorization: `Bearer ${spotify.accessToken}` }
        });
        // Re-poll after a short delay so UI reflects the change
        setTimeout(fetchNowPlaying, 400);
    } catch (e) {}
}

function spotifyPlayPause() {
    const isPaused = document.getElementById('np-play-icon').style.display !== 'none';
    spotifyControl('PUT', isPaused ? 'play' : 'pause');
    // Optimistic UI toggle
    document.getElementById('np-play-icon').style.display  = isPaused ? 'none'  : 'block';
    document.getElementById('np-pause-icon').style.display = isPaused ? 'block' : 'none';
}

function spotifyNext() { spotifyControl('POST', 'next'); }
function spotifyPrev() { spotifyControl('POST', 'previous'); }

function pollSpotify() {
    if (spotify.pollInterval) clearInterval(spotify.pollInterval);
    fetchNowPlaying();
    spotify.pollInterval = setInterval(fetchNowPlaying, 15000);
}

function disconnectSpotify() {
    spotify.accessToken = null;
    spotify.refreshToken = null;
    if (spotify.pollInterval) clearInterval(spotify.pollInterval);
    localStorage.removeItem('spotify_tokens');
    document.getElementById('nowplaying-widget').style.display = 'none';
    updateSpotifyUI();
}

function updateSpotifyUI() {
    const loaded   = loadStoredSpotifyTokens();
    const statusEl = document.getElementById('spotify-status-row');
    const discBtn  = document.getElementById('spotify-disconnect-btn');
    if (loaded && spotify.accessToken) {
        statusEl.innerHTML = `<div class="spotify-connected"><span class="dot"></span> Connected to Spotify</div>`;
        discBtn.style.display = 'block';
    } else {
        statusEl.innerHTML = `<div style="font-size:0.7rem;opacity:0.35;margin-bottom:8px;">Not connected</div>`;
        discBtn.style.display = 'none';
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BACKGROUND
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatic(val) { state.staticColor = val; state.isStatic = true; applyAll(); renderHistory(); save(); }

function handleBg(input) {
    const reader = new FileReader();
    reader.onload = e => {
        const data = e.target.result;
        state.bg = data; state.isStatic = false;
        state.history = [data, ...state.history.filter(x => x !== data)].slice(0, 3);
        applyAll(); renderHistory(); save();
    };
    reader.readAsDataURL(input.files[0]);
}

function renderHistory() {
    const container = document.getElementById('bg-history');
    container.innerHTML = '';
    state.history.forEach(data => {
        const thumb = document.createElement('div');
        thumb.className = `bg-thumb ${(!state.isStatic && state.bg === data) ? 'active' : ''}`;
        thumb.style.backgroundImage = `url(${data})`;
        thumb.onclick = () => { state.bg = data; state.isStatic = false; applyAll(); renderHistory(); save(); };
        container.appendChild(thumb);
    });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// THEMES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveTheme() {
    const name = document.getElementById('theme-name').value.trim();
    if (!name) return;
    const t = JSON.parse(JSON.stringify(state));
    delete t.presets;
    state.presets[name] = t;
    document.getElementById('theme-name').value = '';
    renderThemeList(); save();
}

function loadTheme(name) {
    const presets = state.presets;
    state = JSON.parse(JSON.stringify(state.presets[name]));
    state.presets = presets;
    applyAll(); renderHistory(); save();
}

function deleteTheme(name) { delete state.presets[name]; renderThemeList(); save(); }

function renderThemeList() {
    const list = document.getElementById('theme-list');
    list.innerHTML = '';
    Object.keys(state.presets).forEach(name => {
        const item = document.createElement('div');
        item.className = 'theme-item';
        item.innerHTML = `<span>${name}</span><div class="theme-actions"><button onclick="loadTheme('${name}')" style="color:var(--accent);">LOAD</button><button onclick="deleteTheme('${name}')" style="color:#ff4444;">‚úï</button></div>`;
        list.appendChild(item);
    });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// APPLY ALL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyAll() {
    // ‚îÄ‚îÄ Accent contrast: compute dark/light fg so UI stays readable on white accent ‚îÄ‚îÄ
    const hex = state.accent.replace('#','');
    const ar = parseInt(hex.slice(0,2),16), ag = parseInt(hex.slice(2,4),16), ab = parseInt(hex.slice(4,6),16);
    const lum = (0.299*ar + 0.587*ag + 0.114*ab) / 255;
    document.documentElement.style.setProperty('--accent', state.accent);
    document.documentElement.style.setProperty('--accent-fg', lum > 0.65 ? '#111' : '#fff');
    document.documentElement.style.setProperty('--widget-scale', state.scale);

    const bgl = document.getElementById('bg-layer');
    // Only show user bg if artAsBg is off (art bg handled in extractAccentFromArt)
    if (!state.artAsBg) {
        if (state.isStatic) {
            document.body.style.backgroundColor = state.staticColor;
            document.getElementById('static-bg-preview').style.backgroundColor = state.staticColor;
            bgl.style.backgroundImage = 'none';
        } else {
            document.body.style.backgroundColor = '#000';
            bgl.style.backgroundImage = `url(${state.bg})`;
        }
    }
    document.getElementById('static-bg-preview').classList.toggle('active', state.isStatic);
    bgl.style.filter  = `blur(${state.blur}px)`;
    bgl.style.opacity = state.bgOpacity;

    document.getElementById('sw-mirrored').classList.toggle('active', state.mirrored);
    document.getElementById('sw-is24h').classList.toggle('active', state.is24h);
    document.getElementById('sw-burnShield').classList.toggle('active', state.burnShield);
    document.getElementById('sw-showSeconds').classList.toggle('active', !!state.showSeconds);
    document.getElementById('sw-showPills').classList.toggle('active', !!state.showPills);
    document.getElementById('sw-artAsBg').classList.toggle('active', !!state.artAsBg);
    document.body.classList.toggle('show-pills', !!state.showPills);

    const unitC = document.getElementById('unit-c');
    const unitF = document.getElementById('unit-f');
    if (unitC) unitC.classList.toggle('active', state.weatherUnit !== 'F');
    if (unitF) unitF.classList.toggle('active', state.weatherUnit === 'F');

    const widgets = ['clock', 'date', 'weather', 'battery', 'nowplaying', 'stocks'];
    widgets.forEach(key => {
        const el   = document.getElementById(key + '-widget');
        if (!el) return;
        const show = state['show' + key.charAt(0).toUpperCase() + key.slice(1)];
        el.style.opacity = show ? 1 : 0;
        el.style.pointerEvents = show ? 'all' : 'none';
        if (show && key !== 'nowplaying') el.style.display = 'flex';
        positionWidget(key);
        const sw = document.getElementById('sw-show' + key.charAt(0).toUpperCase() + key.slice(1));
        if (sw) sw.classList.toggle('active', show);
        const st = document.getElementById('st-' + key);
        if (st) { st.innerText = show ? 'SHOWN' : 'HIDDEN'; st.className = show ? 'status-tag on' : 'status-tag off'; }
    });

    renderTickerTags();

    document.getElementById('city-input').value  = state.city;
    document.getElementById('range-scale').value = state.scale;

    applyClockStyle(state.clockStyle || 'bold');

    document.getElementById('amb-vol').value = state.ambientVolume;
    const ambStatus = document.getElementById('amb-status');
    if (state.ambientSound) {
        ambStatus.innerText = state.ambientSound.toUpperCase();
        ambStatus.className = 'status-tag on';
    }

    document.getElementById('color-accent').value = state.accent;
    updateGhostSize();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SNAP ZONES ‚Äî 11√ó15 invisible grid (165 points)
// 11 columns √ó 15 rows, margins kept so widgets don't clip edges
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ZONES = (() => {
    const cols = 11, rows = 15;
    const z = [];
    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            z.push({
                x: 5 + (c / (cols - 1)) * 90,
                y: 4 + (r / (rows - 1)) * 92
            });
        }
    }
    return z;
})(); // 165 zones

const WIDGET_KEYS = ['clock', 'date', 'weather', 'battery', 'nowplaying', 'stocks'];
const DEFAULT_POS = {
    clock:      { x: 50, y: 28 },
    date:       { x: 50, y: 50 },
    weather:    { x: 50, y: 72 },
    battery:    { x: 83, y: 6  },
    nowplaying: { x: 50, y: 94 },
    stocks:     { x: 17, y: 50 }
};

function positionWidget(key) {
    if (!state.widgetPos) state.widgetPos = JSON.parse(JSON.stringify(DEFAULT_POS));
    const pos = state.widgetPos[key] || DEFAULT_POS[key];
    const el  = document.getElementById(key + '-widget');
    if (!el) return;
    el.style.left = pos.x + '%';
    el.style.top  = pos.y + '%';
    const sx = state.mirrored ? -state.scale : state.scale;
    el.style.transform = `translate(-50%, -50%) scale(${sx}, ${state.scale})`;
}

// Ghost system is fully removed ‚Äî grid is invisible
function updateGhostSize() {} // no-op kept so applyAll doesn't error
function createSnapGhosts() {} // no-op
function showGhosts() {}
function hideGhosts() {}
function highlightGhost() {}

// Find nearest zone in pixel space
function nearestZoneIdx(pxX, pxY) {
    const vw = window.innerWidth, vh = window.innerHeight;
    let best = 0, bestDist = Infinity;
    ZONES.forEach((z, i) => {
        const gx = z.x / 100 * vw;
        const gy = z.y / 100 * vh;
        const d  = Math.hypot(gx - pxX, gy - pxY);
        if (d < bestDist) { bestDist = d; best = i; }
    });
    return best;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DRAG ENGINE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initWidgetDrag(key) {
    const el = document.getElementById(key + '-widget');
    if (!el) return;

    // ‚îÄ‚îÄ MOUSE (desktop): drag immediately on mousedown ‚îÄ‚îÄ
    el.addEventListener('mousedown', (e) => {
        if (e.target.closest('button, input, a')) return;
        startDrag(key, el, e, false);
    });

    // ‚îÄ‚îÄ TOUCH (mobile): require 300ms long-press before drag activates ‚îÄ‚îÄ
    let longPressTimer = null;
    let touchCancelled = false;

    el.addEventListener('touchstart', (e) => {
        if (e.target.closest('button, input, a')) return;
        touchCancelled = false;
        longPressTimer = setTimeout(() => {
            if (!touchCancelled) {
                if (navigator.vibrate) navigator.vibrate(30);
                el.classList.add('long-press-ready');
                setTimeout(() => el.classList.remove('long-press-ready'), 400);
                el.classList.add('dragging');
                showGhosts();
                startDrag(key, el, e, true, true);
            }
        }, 300);
    }, { passive: true });

    el.addEventListener('touchend',   () => { clearTimeout(longPressTimer); touchCancelled = true; });
    el.addEventListener('touchmove',  (e) => {
        // If moved before long-press fires, cancel it (it's a scroll, not a drag)
        clearTimeout(longPressTimer);
        touchCancelled = true;
    }, { passive: true });
}

function startDrag(key, el, startEvent, isTouch, alreadyActivated = false) {
    const getXY = ev => isTouch
        ? { cx: ev.touches[0].clientX, cy: ev.touches[0].clientY }
        : { cx: ev.clientX, cy: ev.clientY };

    const { cx: startX, cy: startY } = getXY(startEvent);
    if (!state.widgetPos) state.widgetPos = JSON.parse(JSON.stringify(DEFAULT_POS));
    const origPos = { ...state.widgetPos[key] };
    let moved = alreadyActivated;
    let curPxX = origPos.x / 100 * window.innerWidth;
    let curPxY = origPos.y / 100 * window.innerHeight;

    if (alreadyActivated) {
        curPxX = startX;
        curPxY = startY;
    }

    const onMove = (ev) => {
        if (isTouch) ev.preventDefault();
        const { cx, cy } = getXY(ev);
        const dx = cx - startX, dy = cy - startY;
        if (!moved && Math.hypot(dx, dy) < 8) return;

        if (!moved) {
            moved = true;
            el.classList.add('dragging');
            showGhosts();
        }

        curPxX = Math.min(window.innerWidth  * 0.95, Math.max(window.innerWidth  * 0.05, (origPos.x / 100 * window.innerWidth)  + dx));
        curPxY = Math.min(window.innerHeight * 0.95, Math.max(window.innerHeight * 0.05, (origPos.y / 100 * window.innerHeight) + dy));

        el.style.transition = 'opacity 0.15s ease';
        el.style.left = (curPxX / window.innerWidth  * 100) + '%';
        el.style.top  = (curPxY / window.innerHeight * 100) + '%';
        highlightGhost(curPxX, curPxY);
    };

    const onEnd = () => {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup',   onEnd);
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend',  onEnd);
        el.classList.remove('dragging');
        el.style.transition = '';
        hideGhosts();
        if (!moved) return;
        const zone = ZONES[nearestZoneIdx(curPxX, curPxY)];
        state.widgetPos[key] = { x: zone.x, y: zone.y };
        positionWidget(key);
        save();
    };

    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup',   onEnd);
    document.addEventListener('touchmove', onMove, { passive: false });
    document.addEventListener('touchend',  onEnd);
}

function initAllDrag() {
    WIDGET_KEYS.forEach(key => initWidgetDrag(key));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BURN SHIELD ‚Äî tiny random drift via CSS var
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startBurnShield() {
    setInterval(() => {
        WIDGET_KEYS.forEach(key => {
            const el = document.getElementById(key + '-widget');
            if (!el || !state.burnShield) return;
            const dx = (Math.random() * 3 - 1.5).toFixed(1);
            const dy = (Math.random() * 3 - 1.5).toFixed(1);
            el.style.marginLeft = dx + 'px';
            el.style.marginTop  = dy + 'px';
        });
    }, 60000);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// WIDGET HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetWidget(key) {
    if (!state.widgetPos) state.widgetPos = {};
    state.widgetPos[key] = { ...DEFAULT_POS[key] };
    state['show' + key.charAt(0).toUpperCase() + key.slice(1)] = true;
    applyAll(); save();
}
function toggle(key) {
    state[key] = !state[key];
    applyAll();
    // When stocks are turned on, start fetching; when turned off, stop
    if (key === 'showStocks') {
        const el = document.getElementById('stocks-widget');
        if (state.showStocks) {
            el.style.display = 'flex';
            startStocksPolling();
        } else {
            el.style.display = 'none';
            clearInterval(stocksRefreshTimer);
        }
    }
    save();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODALS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal()  { document.getElementById('confirm-modal').style.display = 'flex'; }
function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }
function performFactoryReset() { localStorage.clear(); location.reload(); }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PREVENT PAGE SCROLL (all devices, especially iOS)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('touchmove', e => {
    // Allow scrolling only inside the side panel
    if (e.target.closest('#side-panel')) return;
    e.preventDefault();
}, { passive: false });

document.addEventListener('wheel', e => {
    if (!e.target.closest('#side-panel')) e.preventDefault();
}, { passive: false });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BOOT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
load();
</script>
</body>
</html>
