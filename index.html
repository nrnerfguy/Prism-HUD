<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <title>Prism OS | Ultra-Dense Kernel</title>
    <style>
        /* PRISM OS KERNEL STYLESHEET 
           VERSION: 4.5.0
           MODULE: UI-DENSITY-MAX
        */
        :root {
            --accent: #007AFF; 
            --accent-rgb: 0, 122, 255;
            --bg-opacity: 1;
            --bg-blur: 0px;
            --smooth-ease: cubic-bezier(0.4, 0, 0.2, 1);
            --slow-ease: cubic-bezier(0.65, 0, 0.35, 1);
            --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --widget-shadow: 0px 10px 40px rgba(0,0,0,0.8);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
            -webkit-user-select: none;
            outline: none;
        }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        @keyframes noise {
            0% { transform: translate(0,0) }
            10% { transform: translate(-5%,-5%) }
            20% { transform: translate(-10%,5%) }
            30% { transform: translate(5%,-10%) }
            40% { transform: translate(-5%,15%) }
            50% { transform: translate(-10%,5%) }
            60% { transform: translate(15%,0) }
            70% { transform: translate(0,10%) }
            80% { transform: translate(-15%,0) }
            90% { transform: translate(10%,5%) }
            100% { transform: translate(5%,0) }
        }

        html, body {
            background-color: #000; color: #fff; margin: 0; padding: 0;
            width: 100vw; height: 100vh; height: 100dvh;
            display: flex; justify-content: center; align-items: center;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            perspective: 1000px;
        }

        body { animation: pageEntrance 2.2s var(--slow-ease) forwards; opacity: 0; }
        
        @keyframes pageEntrance {
            from { opacity: 0; transform: scale(1.1) translateZ(-100px); filter: blur(20px); }
            to { opacity: 1; transform: scale(1) translateZ(0); filter: blur(0px); }
        }

        #bg-layer {
            position: fixed; inset: -150px; z-index: -2;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            transition: opacity 1.2s ease, filter 1.2s ease, transform 0.1s linear;
            filter: blur(var(--bg-blur)) brightness(0.6); opacity: var(--bg-opacity);
            will-change: transform, opacity;
        }

        #vignette {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.4) 100%);
            pointer-events: none;
        }

        #hud-master {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; transition: transform 1s var(--smooth-ease), opacity 0.5s ease;
            will-change: transform; position: relative; z-index: 10;
        }

        .widget { 
            transition: all 0.6s var(--smooth-ease); 
            color: var(--accent); 
            filter: drop-shadow(var(--widget-shadow)); 
            width: 100%;
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }

        /* --- CLOCK MODULE --- */
        #clock-container { position: relative; margin-bottom: 10px; }
        #clock { 
            font-size: clamp(6rem, 30vw, 16rem); 
            font-weight: 900; 
            font-style: italic; 
            letter-spacing: -8px; 
            line-height: 0.85; 
            text-shadow: 0px 15px 45px rgba(0,0,0,0.7);
            padding: 0 30px;
            background: linear-gradient(180deg, #fff 30%, rgba(255,255,255,0.4) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #date { 
            font-size: 1.6rem; 
            text-transform: uppercase; 
            letter-spacing: 12px; 
            opacity: 0.8; 
            font-weight: 200; 
            margin-top: -10px;
            color: var(--accent);
            text-shadow: 0 0 20px rgba(var(--accent-rgb), 0.5);
        }

        /* --- APPLE CALENDAR ENGINE --- */
        #calendar-widget { 
            margin-top: 30px; 
            flex-direction: column; 
            background: var(--glass); 
            padding: 25px; 
            border-radius: 32px; 
            backdrop-filter: blur(30px); 
            border: 1px solid var(--glass-border); 
            width: 320px; 
            box-shadow: inset 0 0 20px rgba(255,255,255,0.02);
        }
        .cal-header { 
            font-size: 0.85rem; 
            font-weight: 900; 
            letter-spacing: 4px; 
            margin-bottom: 15px; 
            color: #fff;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; width: 100%; }
        .cal-day { font-size: 0.8rem; padding: 8px; text-align: center; border-radius: 10px; color: rgba(255,255,255,0.9); font-weight: 500; transition: 0.3s; }
        .cal-day.today { 
            background: var(--accent); 
            color: #000; 
            font-weight: 900; 
            box-shadow: 0 8px 20px rgba(var(--accent-rgb), 0.4); 
            transform: scale(1.1);
        }
        .cal-label { font-size: 0.65rem; opacity: 0.3; font-weight: 900; text-transform: uppercase; }

        /* --- MARKET TICKER MODULE --- */
        #market-widget { 
            margin-top: 40px; 
            gap: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            max-width: 500px;
        }
        .ticker-box { 
            background: var(--glass); 
            padding: 15px 20px; 
            border-radius: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-width: 100px;
            border: 1px solid var(--glass-border);
            transition: transform 0.4s var(--bounce);
        }
        .ticker-box:hover { transform: translateY(-10px) scale(1.05); background: rgba(255,255,255,0.06); }
        .t-sym { font-size: 0.65rem; font-weight: 900; opacity: 0.5; color: #fff; letter-spacing: 1px; }
        .t-val { font-size: 1.1rem; font-weight: 800; color: #fff; margin: 4px 0; font-variant-numeric: tabular-nums; }
        .t-pct { font-size: 0.7rem; font-weight: 900; padding: 2px 8px; border-radius: 6px; }
        .t-up { color: #30D158; background: rgba(48, 209, 88, 0.1); } 
        .t-down { color: #FF453A; background: rgba(255, 69, 58, 0.1); }

        /* --- WEATHER & BIO-SYSTEMS --- */
        #weather-widget { gap: 20px; font-size: 3.2rem; font-weight: 100; margin-top: 25px; }
        #weather-widget svg { width: 55px; height: 55px; filter: drop-shadow(0 0 10px var(--accent)); }
        #temp { font-variant-numeric: tabular-nums; letter-spacing: -2px; }
        
        #battery-widget { 
            font-size: 1rem; 
            font-weight: 900; 
            opacity: 0.5; 
            margin-top: 20px; 
            letter-spacing: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bat-icon { width: 35px; height: 18px; border: 2px solid #fff; border-radius: 4px; position: relative; padding: 2px; }
        .bat-level { height: 100%; background: var(--accent); border-radius: 1px; transition: width 1s ease; }

        /* --- SETTINGS NAVIGATION --- */
        #nav-trigger {
            position: absolute; bottom: 50px; right: 50px; width: 80px; height: 80px;
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            cursor: pointer; transition: 0.7s var(--bounce); opacity: 0; color: #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #nav-ghost-zone { position: absolute; bottom: 0; right: 0; width: 220px; height: 220px; z-index: 999; }
        #nav-trigger:hover { opacity: 1 !important; transform: scale(1.15) rotate(90deg); border-color: var(--accent); }

        /* --- ULTRA SIDE PANEL --- */
        #side-panel {
            position: fixed; right: -460px; top: 0; bottom: 0; width: 440px;
            background: rgba(5, 5, 5, 0.98); backdrop-filter: blur(100px);
            padding: 60px 40px; transition: right 0.7s var(--slow-ease); z-index: 2000;
            overflow-y: auto; border-left: 1px solid var(--glass-border); 
            scrollbar-width: none; box-shadow: -20px 0 50px rgba(0,0,0,0.9);
        }
        #side-panel::-webkit-scrollbar { display: none; }
        #side-panel.open { right: 0 !important; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 1500; backdrop-filter: blur(10px); }

        /* --- CONTROL SYSTEM --- */
        .control-group { 
            padding: 25px; background: rgba(255,255,255,0.02); 
            border-radius: 28px; border: 1px solid var(--glass-border); 
            margin-bottom: 25px; position: relative; overflow: hidden;
        }
        .section-title { font-size: 0.75rem; font-weight: 900; text-transform: uppercase; letter-spacing: 3px; color: var(--accent); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .section-title::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }
        
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        label { font-size: 0.8rem; font-weight: 600; opacity: 0.6; }
        
        /* --- IOS TOGGLES & INPUTS --- */
        .ios-switch { position: relative; width: 56px; height: 32px; background: rgba(255,255,255,0.08); border-radius: 20px; cursor: pointer; transition: 0.4s var(--smooth-ease); }
        .ios-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 26px; height: 26px; background: #fff; border-radius: 50%; transition: 0.4s var(--bounce); box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .ios-switch.active { background: var(--accent); }
        .ios-switch.active::after { transform: translateX(24px); }

        .tag-cloud { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .tag { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #fff; padding: 8px 14px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .tag:hover { border-color: var(--accent); color: var(--accent); transform: scale(1.05); }

        input[type="text"], input[type="number"] { 
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); 
            color: #fff; padding: 16px; border-radius: 16px; outline: none; font-weight: 600; transition: 0.3s;
        }
        input[type="text"]:focus { border-color: var(--accent); background: rgba(0,0,0,0.6); }

        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(255,255,255,0.08); border-radius: 10px; margin: 20px 0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 26px; width: 26px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 0 15px rgba(0,0,0,0.5); border: 2px solid var(--accent); }

        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .preset-btn { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); color: #fff; padding: 15px; border-radius: 16px; font-size: 0.75rem; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .preset-btn:hover { background: var(--accent); color: #000; transform: translateY(-3px); }

        /* --- POWER MODULE --- */
        .power-btn { 
            width: 100%; padding: 20px; border-radius: 20px; 
            background: rgba(255,69,58,0.05); color: #FF453A; 
            border: 1px solid rgba(255,69,58,0.2); font-weight: 900; 
            cursor: pointer; transition: 0.4s; letter-spacing: 2px;
            margin-top: 20px;
        }
        .power-btn:hover { background: #FF453A; color: #fff; box-shadow: 0 10px 30px rgba(255,69,58,0.3); }

        /* --- RESPONSIVE OPTIMIZATION --- */
        @media (max-width: 768px) {
            #side-panel { width: 100vw; right: -100vw; padding: 40px 20px; }
            #clock { font-size: 22vw; }
            #nav-trigger { bottom: 20px; right: 20px; width: 60px; height: 60px; }
        }
    </style>
</head>
<body>

    <div id="bg-layer"></div>
    <div id="vignette"></div>
    <div id="overlay" onclick="toggleNav()"></div>

    <div id="hud-master">
        <div id="clock-container">
            <div id="clock-widget" class="widget"><div id="clock">00:00</div></div>
            <div id="date-widget" class="widget"><div id="date">SYSTEM BOOTING</div></div>
        </div>
        
        <div id="calendar-widget" class="widget">
            <div class="cal-header">
                <span id="cal-mo">JANUARY</span>
                <span style="opacity:0.4" id="cal-yr">2026</span>
            </div>
            <div class="cal-grid" id="cal-body"></div>
        </div>

        <div id="market-widget" class="widget"></div>

        <div id="weather-widget" class="widget">
            <div id="w-icon"></div>
            <span id="temp">--°C</span>
        </div>

        <div id="battery-widget" class="widget">
            <div class="bat-icon"><div id="bat-fill" class="bat-level" style="width: 0%"></div></div>
            <span id="bat-val">--%</span>
        </div>
    </div>

    <div id="nav-ghost-zone" onmousemove="wakeNav()" onclick="wakeNav()"></div>
    <div id="nav-trigger" onclick="toggleNav()">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </div>

    <div id="side-panel">
        <div class="panel-content">
            <h1 style="margin:0; font-size: 2.5rem; font-weight: 900; letter-spacing: -2px;">Prism<span style="color:var(--accent)">OS</span></h1>
            <p style="opacity:0.3; font-size: 0.7rem; font-weight: 800; margin-bottom: 40px; letter-spacing: 2px;">ULTRA-CORE V4.5 // STABLE_BUILD</p>
            
            <div class="control-group">
                <div class="section-title">System Modules</div>
                <div class="row"><label>Show Calendar</label><div id="sw-showCalendar" class="ios-switch" onclick="toggle('showCalendar')"></div></div>
                <div class="row"><label>Live Markets</label><div id="sw-showMarket" class="ios-switch" onclick="toggle('showMarket')"></div></div>
                <div class="row"><label>OLED Pixel Shifter</label><div id="sw-burnShield" class="ios-switch" onclick="toggle('burnShield')"></div></div>
                <div class="row"><label>24H Military Time</label><div id="sw-is24h" class="ios-switch" onclick="toggle('is24h')"></div></div>
            </div>

            <div class="control-group">
                <div class="section-title">Market Configuration</div>
                <p style="font-size: 0.6rem; opacity: 0.4; margin-bottom: 10px;">Enter ticker symbols (e.g., TSLA, BTC-USD, ETH-USD):</p>
                <input type="text" id="m-in" placeholder="ADD SYMBOL..." onkeydown="if(event.key==='Enter')addStock(this.value)">
                <div id="stock-tags" class="tag-cloud"></div>
            </div>

            <div class="control-group">
                <div class="section-title">Visual Interface</div>
                <div class="row">
                    <label>Accent Tone</label>
                    <input type="color" id="color-accent" style="width:60px; height:34px; border:none; background:none; cursor:pointer;" onchange="state.accent=this.value; applyAll(); save();">
                </div>
                <label>Kernel Scaling</label>
                <input type="range" min="0.4" max="1.8" step="0.01" value="1" id="sl-scale" oninput="state.scale=this.value; applyAll();">
                <label>Gaussian Blur Strength</label>
                <input type="range" min="0" max="120" step="1" value="0" id="sl-blur" oninput="state.blur=this.value; applyAll();">
            </div>

            <div class="control-group">
                <div class="section-title">Wallpaper Engine</div>
                <input type="text" id="bg-url" placeholder="IMAGE SOURCE URL..." onkeydown="if(event.key==='Enter')setBG(this.value)">
                <div class="preset-grid">
                    <button class="preset-btn" onclick="setBG('https://images.unsplash.com/photo-1614850523296-d8c1af93d400')">NEBULA</button>
                    <button class="preset-btn" onclick="setBG('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986')">DEEP SPACE</button>
                    <button class="preset-btn" onclick="setBG('https://images.unsplash.com/photo-1502657877623-f66bf489d236')">MINIMAL FOG</button>
                    <button class="preset-btn" onclick="setBG('https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3')">ASTRO</button>
                </div>
            </div>

            <div class="control-group">
                <div class="section-title">Geospatial Data</div>
                <input type="text" id="loc-in" placeholder="CITY, COUNTRY..." onkeydown="if(event.key==='Enter')updateLocation(this.value)">
            </div>

            <button class="power-btn" onclick="factoryReset()">WIPE CORE & REBOOT</button>
            <div style="height:100px"></div>
        </div>
    </div>

    <script>
        /* PRISM OS KERNEL LOGIC
           HANDLES: PERSISTENCE, API BRIDGING, CALENDAR MATH, & PIXEL SHIFTING
        */

        let state = {
            is24h: true, 
            showMarket: true, 
            showCalendar: true, 
            burnShield: true,
            scale: 1, 
            accent: '#007AFF', 
            city: 'Calgary', 
            stocks: ['BTC-USD', 'ETH-USD', 'AAPL', 'NVDA', 'TSLA', 'MSFT'],
            bg: 'https://images.unsplash.com/photo-1614850523296-d8c1af93d400', 
            blur: 0, 
            nudgeX: 0, 
            nudgeY: 0
        };

        const STORAGE_KEY = 'prism_ultra_kernel_v4_5';

        // --- CORE KERNEL START ---
        function init() {
            loadPersistence();
            startUpdateCycles();
            renderStockTags();
            applyAll();
            
            // Interaction listeners
            window.addEventListener('mousemove', (e) => {
                if(!state.burnShield) return;
                const moveX = (e.clientX - window.innerWidth / 2) * 0.01;
                const moveY = (e.clientY - window.innerHeight / 2) * 0.01;
                document.getElementById('bg-layer').style.transform = `translate(${moveX}px, ${moveY}px) scale(1.1)`;
            });
        }

        function loadPersistence() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                try {
                    state = Object.assign(state, JSON.parse(saved));
                } catch(e) { console.error("Kernel Load Error", e); }
            }
            
            // Sync DOM to state
            document.getElementById('sl-scale').value = state.scale;
            document.getElementById('sl-blur').value = state.blur;
            document.getElementById('color-accent').value = state.accent;
            document.getElementById('bg-url').value = state.bg;
            document.getElementById('loc-in').value = state.city;
        }

        function save() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function startUpdateCycles() {
            updateClock();
            fetchWeather();
            fetchMarkets();
            updateBattery();
            
            setInterval(updateClock, 1000);
            setInterval(fetchMarkets, 60000); // 1 min market refresh
            setInterval(fetchWeather, 900000); // 15 min weather refresh
            
            // OLED Burn Shield Algorithm (shifts pixels slightly every 30s)
            setInterval(() => {
                if(state.burnShield) {
                    state.nudgeX = (Math.random() * 6) - 3;
                    state.nudgeY = (Math.random() * 6) - 3;
                    document.getElementById('hud-master').style.transform = `scale(${state.scale}) translate(${state.nudgeX}px, ${state.nudgeY}px)`;
                }
            }, 30000);
        }

        // --- INTERFACE ENGINE ---
        function applyAll() {
            const root = document.documentElement;
            root.style.setProperty('--accent', state.accent);
            root.style.setProperty('--bg-blur', state.blur + 'px');
            
            // Convert Hex to RGB for transparency usage
            const hex = state.accent.replace('#','');
            const r = parseInt(hex.substring(0,2), 16);
            const g = parseInt(hex.substring(2,4), 16);
            const b = parseInt(hex.substring(4,6), 16);
            root.style.setProperty('--accent-rgb', `${r}, ${g}, ${b}`);

            document.getElementById('hud-master').style.transform = `scale(${state.scale})`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${state.bg}')`;
            
            // Toggle Logic
            const keys = ['showCalendar', 'showMarket', 'is24h', 'burnShield'];
            keys.forEach(k => {
                document.getElementById(`sw-${k}`).classList.toggle('active', state[k]);
            });

            document.getElementById('calendar-widget').style.display = state.showCalendar ? 'flex' : 'none';
            document.getElementById('market-widget').style.display = state.showMarket ? 'flex' : 'none';
            
            if(state.showCalendar) renderCalendar();
        }

        function toggle(k) {
            state[k] = !state[k];
            applyAll();
            save();
        }

        function toggleNav() {
            const sp = document.getElementById('side-panel');
            const ov = document.getElementById('overlay');
            const isOpen = sp.classList.toggle('open');
            ov.style.display = isOpen ? 'block' : 'none';
        }

        function wakeNav() {
            const btn = document.getElementById('nav-trigger');
            btn.style.opacity = "0.8";
            clearTimeout(window.navTimer);
            window.navTimer = setTimeout(() => { 
                if(!document.getElementById('side-panel').classList.contains('open')) btn.style.opacity = "0"; 
            }, 3000);
        }

        // --- DATA VISUALIZERS ---
        function updateClock() {
            const now = new Date();
            let h = now.getHours();
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            
            if (!state.is24h) h = h % 12 || 12;
            
            document.getElementById('clock').innerHTML = `${h}:${m}<span style="font-size:0.2em; opacity:0.3; margin-left:10px">${s}</span>`;
            document.getElementById('date').innerText = now.toLocaleDateString('en-US', { 
                weekday: 'long', month: 'long', day: '2-digit' 
            }).toUpperCase();
        }

        function renderCalendar() {
            const now = new Date();
            const body = document.getElementById('cal-body');
            document.getElementById('cal-mo').innerText = now.toLocaleString('default', { month: 'long' }).toUpperCase();
            document.getElementById('cal-yr').innerText = now.getFullYear();
            
            body.innerHTML = 'SMTWTFS'.split('').map(l => `<div class="cal-day cal-label">${l}</div>`).join('');
            
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            
            for(let i=0; i<firstDay; i++) body.innerHTML += '<div></div>';
            for(let d=1; d<=daysInMonth; d++) {
                const isToday = (d === now.getDate()) ? 'today' : '';
                body.innerHTML += `<div class="cal-day ${isToday}">${d}</div>`;
            }
        }

        async function fetchMarkets() {
            if(!state.showMarket || state.stocks.length === 0) return;
            try {
                // Yahoo Finance Query Bridge
                const res = await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${state.stocks.join(',')}`);
                const data = await res.json();
                const container = document.getElementById('market-widget');
                container.innerHTML = '';
                
                data.quoteResponse.result.forEach(q => {
                    const chg = q.regularMarketChangePercent || 0;
                    const isUp = chg >= 0;
                    container.innerHTML += `
                        <div class="ticker-box">
                            <span class="t-sym">${q.symbol}</span>
                            <span class="t-val">$${q.regularMarketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                            <span class="t-pct ${isUp ? 't-up' : 't-down'}">
                                ${isUp ? '▲' : '▼'} ${Math.abs(chg).toFixed(2)}%
                            </span>
                        </div>`;
                });
            } catch(e) { 
                console.warn("Market API Offline"); 
                document.getElementById('market-widget').innerHTML = '<p style="opacity:0.2; font-size:0.7rem">MARKET DATA UNAVAILABLE</p>';
            }
        }

        async function fetchWeather() {
            try {
                // Step 1: Geocoding
                const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${state.city}&count=1`).then(r => r.json());
                if(!geo.results) return;
                
                const { latitude, longitude } = geo.results[0];
                
                // Step 2: Forecast
                const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code`).then(r => r.json());
                
                document.getElementById('temp').innerText = Math.round(w.current.temperature_2m) + "°C";
                
                // Weather Icon Mapping
                const code = w.current.weather_code;
                let iconSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>'; // Clear
                
                if(code > 0) {
                    iconSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.5-2-4.5-4.5-4.5-.1 0-.3 0-.4 0-0.6-3.1-3.3-5.5-6.6-5.5-3.7 0-6.7 3-6.7 6.7 0 .2 0 .3 0 .5C1.6 12.4 0 14.5 0 17c0 3.3 2.7 6 6 6h11.5"/></svg>'; // Clouds
                }
                document.getElementById('w-icon').innerHTML = iconSvg;
            } catch(e) { console.warn("Weather API Offline"); }
        }

        // --- UTILITY KERNEL ---
        function addStock(v) {
            const s = v.toUpperCase().trim();
            if(s && !state.stocks.includes(s)) {
                state.stocks.push(s);
                renderStockTags();
                fetchMarkets();
                save();
            }
            document.getElementById('m-in').value = '';
        }

        function renderStockTags() {
            const div = document.getElementById('stock-tags');
            div.innerHTML = '';
            state.stocks.forEach(s => {
                const span = document.createElement('span'); 
                span.className = 'tag'; 
                span.innerHTML = `${s} <span style="opacity:0.3; margin-left:5px">×</span>`;
                span.onclick = () => { 
                    state.stocks = state.stocks.filter(x => x !== s); 
                    renderStockTags(); 
                    fetchMarkets(); 
                    save(); 
                };
                div.appendChild(span);
            });
        }

        async function updateBattery() {
            if(navigator.getBattery) {
                const b = await navigator.getBattery();
                const update = () => {
                    const lvl = Math.round(b.level * 100);
                    document.getElementById('bat-val').innerText = lvl + "%" + (b.charging ? " ⚡" : "");
                    document.getElementById('bat-fill').style.width = lvl + "%";
                    document.getElementById('bat-fill').style.background = lvl < 20 ? "#FF453A" : "var(--accent)";
                };
                update();
                b.onlevelchange = update;
                b.onchargingchange = update;
            }
        }

        function setBG(url) {
            if(!url) return;
            state.bg = url;
            applyAll();
            save();
        }

        function updateLocation(c) {
            if(!c) return;
            state.city = c;
            fetchWeather();
            save();
        }

        function factoryReset() {
            if(confirm("CRITICAL: This will destroy all system configurations and return to kernel defaults. Proceed?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        window.onload = init;
    </script>
</body>
</html>
